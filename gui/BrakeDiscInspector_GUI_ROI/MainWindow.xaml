<Window
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:BrakeDiscInspector_GUI_ROI"
        xmlns:m="clr-namespace:BrakeDiscInspector_GUI_ROI.Models"
        xmlns:services="clr-namespace:BrakeDiscInspector_GUI_ROI.Services"
        xmlns:workflow="clr-namespace:BrakeDiscInspector_GUI_ROI.Workflow"
        xmlns:conv="clr-namespace:BrakeDiscInspector_GUI_ROI.Converters"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        x:Class="BrakeDiscInspector_GUI_ROI.MainWindow"
        Title="BrakeDiscInspector"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BrushAppBackground}"
        UseLayoutRounding="True"
        Loaded="MainWindow_Loaded"
        Closing="MainWindow_Closing"
        mc:Ignorable="d" Height="707">

    <Window.Resources>
        <conv:BoolToEditSaveTextConverter x:Key="BoolToEditSaveText" />
        <conv:BoolToBrushConverter x:Key="BoolToBrush" />
        <conv:BatchCellStatusToBrushConverter x:Key="BatchCellStatusToBrush" />
        <conv:RoiPanelModeToVisibilityConverter x:Key="RoiPanelModeToVisibility" />
        <SolidColorBrush x:Key="BrushAppBackground" Color="{DynamicResource {x:Static SystemColors.ControlColorKey}}" />

        <Style x:Key="TitleTextStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Header}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.WindowTitle}" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
        </Style>
        <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Header}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.SectionTitle}" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
        </Style>
        <Style x:Key="LabelTextStyle" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.ControlLabel}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
        </Style>
        <Style TargetType="TextBlock" BasedOn="{StaticResource LabelTextStyle}" />

        <Style x:Key="AppButtonStyle" TargetType="{x:Type ui:Button}">
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="{DynamicResource UI.Brush.ButtonBackground}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.ButtonForeground}" />
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.ButtonText}" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Effect" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource UI.Brush.ButtonBackgroundHover}" />
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect BlurRadius="12" ShadowDepth="0" Opacity="0.35"
                                              Color="{DynamicResource UI.Color.Accent}" />
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource AppButtonStyle}" />

        <Style TargetType="TextBox">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.ControlText}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>
        <Style TargetType="ComboBox">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.ControlText}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
        </Style>
        <Style TargetType="CheckBox">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.CheckBox}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
        </Style>
        <Style TargetType="{x:Type ui:ToggleSwitch}"
               BasedOn="{StaticResource {x:Type ui:ToggleSwitch}}">
            <Setter Property="FontFamily" Value="{DynamicResource UI.FontFamily.Body}" />
            <Setter Property="FontSize" Value="{DynamicResource UI.FontSize.CheckBox}" />
            <Setter Property="Foreground" Value="{DynamicResource UI.Brush.Foreground}" />
        </Style>

        <Style TargetType="{x:Type GroupBox}" BasedOn="{StaticResource CardGroupBoxStyle}">
        </Style>
    </Window.Resources>

    <Window.InputBindings>
        <KeyBinding Modifiers="Control" Key="O" Command="ApplicationCommands.Open" />
        <KeyBinding Modifiers="Control" Key="S" Command="ApplicationCommands.Save" />
        <KeyBinding Modifiers="Control" Key="L" Command="ApplicationCommands.Find" />
        <KeyBinding Modifiers="Control" Key="E" Command="ApplicationCommands.Print" />
        <KeyBinding Key="F5" Command="NavigationCommands.Refresh" />
    </Window.InputBindings>

    <Grid x:Name="RootGrid">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="NavColumn" Width="220" MinWidth="180" />
            <ColumnDefinition x:Name="SidePanelColumn" Width="520" MinWidth="420" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition />
        </Grid.ColumnDefinitions>

        <!-- ===== Top bar ===== -->
        <Border Grid.Row="0" Grid.ColumnSpan="4" Padding="16,10" Background="{DynamicResource BrushAppBackground}" BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="0,0,0,1">
            <DockPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" DockPanel.Dock="Left">
                    <TextBlock Text="BrakeDiscInspector" Style="{StaticResource TitleTextStyle}" Margin="0,0,12,0" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                    <ui:Button x:Name="SetupGuiButton"
                               Style="{StaticResource AppButtonStyle}"
                               Click="SetupGuiButton_Click"
                               Margin="0,0,8,0"
                               ToolTip="Open GUI setup">
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Settings24}" Margin="0,0,6,0" FontSize="16"/>
                            <TextBlock Text="Setup GUI" VerticalAlignment="Center"/>
                        </StackPanel>
                    </ui:Button>
                    <ui:Button x:Name="ThemeLightButton"
                               Style="{StaticResource AppButtonStyle}"
                               Click="ThemeLightButton_Click"
                               Margin="0,0,6,0"
                               ToolTip="Light theme">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.WeatherSunny24}" FontSize="18"/>
                    </ui:Button>
                    <ui:Button x:Name="ThemeDarkButton"
                               Style="{StaticResource AppButtonStyle}"
                               Click="ThemeDarkButton_Click"
                               ToolTip="Dark theme">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.WeatherMoon24}" FontSize="18"/>
                    </ui:Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <Popup x:Name="GuiSetupPopup"
               PlacementTarget="{Binding ElementName=SetupGuiButton}"
               Placement="Bottom"
               StaysOpen="False"
               Closed="GuiSetupPopup_Closed"
               AllowsTransparency="True"
               PopupAnimation="Fade">
            <Border Background="{DynamicResource BrushAppBackground}"
                    BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16"
                    Width="560">
                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="520">
                    <StackPanel>
                        <TextBlock Text="GUI Setup" Style="{StaticResource TitleTextStyle}" Margin="0,0,0,12"/>

                        <TextBlock Text="Typography" Style="{StaticResource HeaderTextStyle}" Margin="0,0,0,8"/>
                        <StackPanel Margin="0,0,0,16">
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Header font" VerticalAlignment="Center"/>
                                <ComboBox x:Name="HeaderFontFamilyCombo"
                                          Grid.Column="1"
                                          Tag="UI.FontFamily.Header"
                                          Margin="8,0"
                                          SelectionChanged="FontFamilyCombo_SelectionChanged"/>
                            </Grid>
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Body font" VerticalAlignment="Center"/>
                                <ComboBox x:Name="BodyFontFamilyCombo"
                                          Grid.Column="1"
                                          Tag="UI.FontFamily.Body"
                                          Margin="8,0"
                                          SelectionChanged="FontFamilyCombo_SelectionChanged"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Window Title" VerticalAlignment="Center"/>
                                <Slider x:Name="WindowTitleFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.WindowTitle"
                                        Minimum="12"
                                        Maximum="32"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=WindowTitleFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Section Title" VerticalAlignment="Center"/>
                                <Slider x:Name="SectionTitleFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.SectionTitle"
                                        Minimum="10"
                                        Maximum="28"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=SectionTitleFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Group Header" VerticalAlignment="Center"/>
                                <Slider x:Name="GroupHeaderFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.GroupHeader"
                                        Minimum="10"
                                        Maximum="28"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=GroupHeaderFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Control Label" VerticalAlignment="Center"/>
                                <Slider x:Name="ControlLabelFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.ControlLabel"
                                        Minimum="10"
                                        Maximum="22"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=ControlLabelFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Control Text" VerticalAlignment="Center"/>
                                <Slider x:Name="ControlTextFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.ControlText"
                                        Minimum="10"
                                        Maximum="22"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=ControlTextFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Button Text" VerticalAlignment="Center"/>
                                <Slider x:Name="ButtonTextFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.ButtonText"
                                        Minimum="10"
                                        Maximum="22"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=ButtonTextFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="CheckBox" VerticalAlignment="Center"/>
                                <Slider x:Name="CheckBoxFontSizeSlider"
                                        Grid.Column="1"
                                        Tag="UI.FontSize.CheckBox"
                                        Minimum="10"
                                        Maximum="22"
                                        ValueChanged="FontSizeSlider_ValueChanged"/>
                                <TextBox Grid.Column="2"
                                         IsReadOnly="True"
                                         TextAlignment="Center"
                                         Text="{Binding ElementName=CheckBoxFontSizeSlider, Path=Value, StringFormat=F0}"/>
                            </Grid>
                        </StackPanel>

                        <TextBlock Text="Colors" Style="{StaticResource HeaderTextStyle}" Margin="0,0,0,8"/>
                        <StackPanel Margin="0,0,0,16">
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Foreground" VerticalAlignment="Center"/>
                                <TextBox x:Name="ForegroundColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.Foreground"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.Foreground}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Accent" VerticalAlignment="Center"/>
                                <TextBox x:Name="AccentColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.Accent"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.Accent}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Button Background" VerticalAlignment="Center"/>
                                <TextBox x:Name="ButtonBackgroundColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.ButtonBackground"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.ButtonBackground}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Hover Background" VerticalAlignment="Center"/>
                                <TextBox x:Name="ButtonHoverBackgroundColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.ButtonBackgroundHover"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.ButtonBackgroundHover}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Button Foreground" VerticalAlignment="Center"/>
                                <TextBox x:Name="ButtonForegroundColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.ButtonForeground"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.ButtonForeground}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="180"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Group Header Foreground" VerticalAlignment="Center"/>
                                <TextBox x:Name="GroupHeaderForegroundColorBox"
                                         Grid.Column="1"
                                         Tag="UI.Brush.GroupHeaderForeground"
                                         LostFocus="ColorTextBox_LostFocus"/>
                                <Rectangle Grid.Column="2"
                                           Width="24"
                                           Height="24"
                                           Stroke="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}"
                                           Fill="{DynamicResource UI.Brush.GroupHeaderForeground}"
                                           Margin="8,0,0,0"/>
                            </Grid>
                        </StackPanel>

                        <TextBlock Text="Diagnostics" Style="{StaticResource HeaderTextStyle}" Margin="0,0,0,6"/>
                        <StackPanel Margin="0,0,0,16">
                            <TextBlock TextWrapping="Wrap">
                                <Run Text="Config: "/>
                                <Run Text="{x:Static services:GuiSetupSettingsService.ConfigPath}"/>
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap">
                                <Run Text="Log: "/>
                                <Run Text="{x:Static services:GuiSetupSettingsService.GuiSetupLogPath}"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <ui:Button Content="Apply" Style="{StaticResource AppButtonStyle}" Margin="0,0,8,0" Click="ApplyColorsButton_Click"/>
                            <ui:Button Content="Reset" Style="{StaticResource AppButtonStyle}" Margin="0,0,8,0" Click="ResetGuiDefaultsButton_Click"/>
                            <ui:Button Content="Close" Style="{StaticResource AppButtonStyle}" Click="CloseGuiSetupButton_Click"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Popup>

        <!-- ===== Side Panel Host ===== -->
        <Grid Grid.Row="1" Grid.Column="1" x:Name="SidePanelHost">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock x:Name="SidePanelTitle"
                       Grid.Row="0"
                       Style="{StaticResource HeaderTextStyle}"
                       FontSize="20"
                       Margin="8,8,8,4"
                       Visibility="Collapsed"/>

            <ScrollViewer x:Name="LayoutSetupPanel" Grid.Row="1" VerticalScrollBarVisibility="Auto" d:Visibility="Visible">
                <StackPanel Margin="8" Orientation="Vertical">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <ui:Button x:Name="BtnLoadImage"
                                   Style="{StaticResource IconTextButtonStyle}"
                                   MinWidth="140"
                                   ToolTip="{DynamicResource LoadPictureTooltip}"
                                   Tag="{x:Static ui:SymbolRegular.Image24}"
                                   Content="{DynamicResource LoadImage}"
                                   Click="BtnLoadImage_Click" />
                        <ui:Button x:Name="BtnLoadLayout"
                                   Style="{StaticResource IconTextButtonStyle}"
                                   MinWidth="140"
                                   ToolTip="{DynamicResource LoadLayoutTooltip}"
                                   Tag="{x:Static ui:SymbolRegular.Folder24}"
                                   Content="{DynamicResource LoadLayout}"
                                   Click="BtnLoadLayout_Click" />
                        <ui:Button x:Name="BtnSaveLayout"
                                   Style="{StaticResource IconTextButtonStyle}"
                                   MinWidth="140"
                                   ToolTip="{DynamicResource SaveLayoutTooltip}"
                                   Tag="{x:Static ui:SymbolRegular.Save24}"
                                   Content="{DynamicResource SaveLayout}"
                                   Click="BtnSaveLayout_Click" />
                    </StackPanel>
                    <ui:ToggleSwitch Content="{DynamicResource LayoutAutosave}"
                                     IsChecked="{Binding LayoutAutosaveEnabled, Mode=TwoWay, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                     Margin="0,0,0,8"/>
                    <GroupBox Header="{DynamicResource Layouts}" Width="441" DataContext="{Binding RelativeSource={RelativeSource AncestorType={x:Type Window}}}" Margin="0,60,0,120" HorizontalAlignment="Center">
                        <StackPanel>
                            <ListBox ItemsSource="{Binding LayoutProfiles.Profiles}"
                                     SelectedItem="{Binding LayoutProfiles.SelectedProfile}"
                                     Height="240">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding DisplayName}" Width="160"/>
                                            <TextBlock Text="{Binding CreatedUtc, StringFormat=\{0:yyyy-MM-dd HH:mm\}}"
                                                       Opacity="0.6"
                                                       Margin="8,0,0,0"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>

                            <WrapPanel Margin="0,8,0,0">
                                <ui:Button Command="{Binding LayoutProfiles.RefreshCommand}" Width="85" Height="45" VerticalAlignment="Center" Padding="0,5,0,6" Margin="4,0,0,0">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left">
                                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.ArrowClockwise24}" Margin="0,0,8,0" FontSize="16"/>
                                        <TextBlock Text="Refresh" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ui:Button>
                                <ui:Button Command="{Binding LayoutProfiles.LoadSelectedCommand}"
                                           Margin="4,0,4,0" Width="73" Height="45" Padding="0,5,0,6">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.ArrowRight24}" Margin="0,0,8,0" FontSize="16"/>
                                        <TextBlock
                                            Text="Load" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ui:Button>
                                <ui:Button Margin="0,0,4,0"
                                           Click="SaveCurrentLayoutAs_Click" Width="85" Height="45" Padding="0,5,11,6">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left" RenderTransformOrigin="0.512,0.553">
                                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" Margin="0,0,8,0" FontSize="16"/>
                                        <TextBlock Text="Save as" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ui:Button>
                                <ui:Button Command="{Binding LayoutProfiles.DeleteSelectedCommand}" Height="45" Width="69" Padding="0,5,0,6">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left">
                                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" Margin="0,0,8,0" FontSize="16"/>
                                        <TextBlock Text="Delete" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ui:Button>
                            </WrapPanel>
                        </StackPanel>
                    </GroupBox>
                </StackPanel>
            </ScrollViewer>

            <ScrollViewer x:Name="RoiManagementPanel" Grid.Row="1" VerticalScrollBarVisibility="Auto" Visibility="Collapsed" d:Visibility="Collapsed">
                <StackPanel Margin="8" Orientation="Vertical">
                    <StackPanel x:Name="RoiManagementSelector"
                                Visibility="{Binding RoiPanelMode, RelativeSource={RelativeSource AncestorType={x:Type Window}}, Converter={StaticResource RoiPanelModeToVisibility}, ConverterParameter=Selector}">
                        <TextBlock Text="Selecciona 'Master ROIs' o 'Inspection ROIs' desde el menÃº de la izquierda."
                                   TextWrapping="Wrap"
                                   Opacity="0.7"
                                   Margin="4,8,4,0"/>
                    </StackPanel>

                    <StackPanel x:Name="MasterRoisPanel"
                                Visibility="{Binding RoiPanelMode, RelativeSource={RelativeSource AncestorType={x:Type Window}}, Converter={StaticResource RoiPanelModeToVisibility}, ConverterParameter=Master}">
                        <StackPanel x:Name="MasterDefaultPanel" Visibility="Visible">
                            <GroupBox x:Name="MasterRoiGroup"
                                      Header="Master ROI"
                                      Margin="10,0,0,0" Height="202" ScrollViewer.VerticalScrollBarVisibility="Disabled" Width="441" HorizontalAlignment="Left">
                                <Grid Margin="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="10*"/>
                                        <ColumnDefinition Width="179*"/>
                                        <ColumnDefinition Width="204*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0" Grid.ColumnSpan="2">
                                        <TextBlock Text="Master 1" FontWeight="SemiBold" Margin="0,0,0,6" FontSize="18" Width="165" HorizontalAlignment="Left"/>
                                        <Grid Width="218" HorizontalAlignment="Left">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" MinWidth="49"/>
                                                <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Shape:" VerticalAlignment="Center" Margin="0,0,8,0" Height="19"/>
                                            <ComboBox x:Name="ComboMasterRoiShape" Grid.Column="1" Height="37" HorizontalAlignment="Left" Width="135" Margin="1,0,0,0">
                                                <ComboBoxItem Content="Rectangle"/>
                                                <ComboBoxItem Content="Circle"/>
                                                <ComboBoxItem Content="Annulus"/>
                                            </ComboBox>
                                        </Grid>
                                        <Grid Margin="0,0,0,6" Width="216" HorizontalAlignment="Left">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" MinWidth="50"/>
                                                <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Type:" VerticalAlignment="Center" Margin="0,0,8,0" Height="19"/>
                                            <ComboBox x:Name="ComboMasterRoiRole" Grid.Column="1" RenderTransformOrigin="0.521,0.527" HorizontalAlignment="Left" Width="135" Height="37"/>
                                        </Grid>
                                        <WrapPanel Width="112" RenderTransformOrigin="0.515,0.547" HorizontalAlignment="Left" Margin="65,0,0,0">
                                            <ui:Button x:Name="BtnEditM1"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       ToolTip="Edit Master 1"
                                                       Click="BtnEditM1_Click" Height="37" Width="37" HorizontalAlignment="Center">
                                                <ui:SymbolIcon x:Name="IconEditM1" Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                            </ui:Button>
                                            <ui:Button x:Name="BtnM1_Remove"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       Click="BtnM1_Remove_Click" Width="37" Height="37" VerticalAlignment="Stretch" HorizontalAlignment="Left">
                                                <StackPanel Orientation="Horizontal" Height="22" HorizontalAlignment="Left" RenderTransformOrigin="1,0.521" Width="17">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" Margin="0,0,8,0" FontSize="16"/>
                                                </StackPanel>
                                            </ui:Button>
                                            <ui:Button x:Name="BtnM1_Create"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       Click="BtnM1_Create_Click" Width="37" Height="37" HorizontalAlignment="Left">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Height="18" Width="15">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Add24}" Margin="0,0,8,0" FontSize="16"/>
                                                </StackPanel>
                                            </ui:Button>
                                        </WrapPanel>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" HorizontalAlignment="Left" Width="188" Margin="10,0,0,0">
                                        <TextBlock Text="Master 2" FontWeight="SemiBold" FontSize="18" Width="146" HorizontalAlignment="Left" Margin="0,0,0,6"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Shape:" VerticalAlignment="Top" Margin="0,10,8,0"/>
                                            <ComboBox x:Name="ComboM2Shape" Grid.Column="1" HorizontalAlignment="Center" Width="135" VerticalAlignment="Center" Height="35">
                                                <ComboBoxItem Content="Rectangle"/>
                                                <ComboBoxItem Content="Circle"/>
                                                <ComboBoxItem Content="Annulus"/>
                                            </ComboBox>
                                        </Grid>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" MinWidth="40"/>
                                                <ColumnDefinition/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Type:" VerticalAlignment="Center" Margin="0,0,8,0" Height="19"/>
                                            <ComboBox x:Name="ComboM2Role" Grid.Column="1" Margin="10,0,0,0" Height="37" HorizontalAlignment="Left" Width="135"/>
                                        </Grid>
                                        <WrapPanel Width="118" HorizontalAlignment="Left" Margin="60,7,0,0">
                                            <ui:Button x:Name="BtnEditM2"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       Margin="4,0,0,0"
                                                       ToolTip="Edit Master 2"
                                                       Click="BtnEditM2_Click" Width="37" Height="37">
                                                <ui:SymbolIcon x:Name="IconEditM2" Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                            </ui:Button>
                                            <ui:Button x:Name="BtnM2_Remove"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       Click="BtnM2_Remove_Click" Width="37" HorizontalAlignment="Center" Height="37">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" Margin="0,0,8,0" FontSize="16"/>
                                                </StackPanel>
                                            </ui:Button>
                                            <ui:Button x:Name="BtnM2_Create"
                                                       MinHeight="26"
                                                       Padding="8,4"
                                                       Click="BtnM2_Create_Click" RenderTransformOrigin="4.067,0.5" HorizontalAlignment="Center" Width="37" Height="37">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Add24}" Margin="0,0,8,0" FontSize="16"/>
                                                </StackPanel>
                                            </ui:Button>
                                        </WrapPanel>
                                    </StackPanel>
                                </Grid>
                            </GroupBox>

                            <WrapPanel Margin="0,12,0,12">
                                <ui:Button x:Name="BtnClearCanvas"
                                           Click="BtnClearCanvas_Click" Margin="10,0,0,0">
                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Eraser24}" Margin="0,0,8,0" FontSize="16"/>
                                        <TextBlock Text="Clear Canvas" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </ui:Button>
                            </WrapPanel>

                            <ui:Button x:Name="BtnAnalyzeMaster"
                                       Click="BtnAnalyzeMaster_Click"
                                       Margin="0,8,0,0">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Target24}" Margin="0,0,8,0" FontSize="16"/>
                                    <TextBlock Text="Force Analyze Master" VerticalAlignment="Center"/>
                                </StackPanel>
                            </ui:Button>

                            <GroupBox Header="Match Options"
                                      Width="260"
                                      DataContext="{Binding RelativeSource={RelativeSource AncestorType={x:Type Window}}}">
                                <StackPanel Margin="8,4,0,0">
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,8">
                                        <TextBlock Text="RotRange:" VerticalAlignment="Center"/>
                                        <TextBox x:Name="TxtRot" Width="60" Margin="4,0,8,0" Text="10"/>
                                        <TextBlock Text="ScaleMin:" VerticalAlignment="Center"/>
                                        <TextBox x:Name="TxtSMin" Width="60" Margin="4,0,8,0" Text="0.95"/>
                                        <TextBlock Text="ScaleMax:" VerticalAlignment="Center"/>
                                        <TextBox x:Name="TxtSMax" Width="60" Margin="4,0,0,0" Text="1.05"/>
                                    </StackPanel>
                                    <WrapPanel>
                                        <ui:Button x:Name="BtnSavePreset" Click="BtnSavePreset_Click" Margin="0,0,8,0">
                                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" Margin="0,0,8,0" FontSize="16"/>
                                                <TextBlock Text="Save Preset" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </ui:Button>
                                    </WrapPanel>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <StackPanel x:Name="MasterAdvancedOptionsPanel"
                                    Visibility="Collapsed"
                                    Margin="0,8,0,0">
                            <Grid Margin="0,12,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" MinWidth="221"/>
                                    <ColumnDefinition Width="9"/>
                                    <ColumnDefinition Width="Auto" MinWidth="228"/>
                                </Grid.ColumnDefinitions>
                                <GroupBox Header="Analyze Options M1"
                                          UseLayoutRounding="False"
                                          Grid.Column="0"
                                          Margin="10,0,10,11"
                                          DataContext="{Binding RelativeSource={RelativeSource AncestorType={x:Type Window}}}">
                                    <StackPanel Margin="0,4,0,0">
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Width="195">
                                            <TextBlock Text="Feature:" VerticalAlignment="Center" Margin="0,0,8,0" HorizontalAlignment="Left"/>
                                            <ComboBox x:Name="ComboFeature" Width="138"
                                                      SelectedValuePath="Content"
                                                      SelectedValue="{Binding AnalyzeFeatureM1, Mode=TwoWay}" Height="37">
                                                <ComboBoxItem Content="auto"/>
                                                <ComboBoxItem Content="sift"/>
                                                <ComboBoxItem Content="orb"/>
                                                <ComboBoxItem Content="tm_rot"/>
                                                <ComboBoxItem Content="edges"/>
                                            </ComboBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Width="191" HorizontalAlignment="Left">
                                            <TextBlock Text="Threshold" VerticalAlignment="Center" Margin="0,0,1,0"/>
                                            <TextBox x:Name="TxtThr" Width="128"
                                                     Margin="4,0,0,0"
                                                     Text="{Binding AnalyzeThrM1, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Height="37"/>
                                        </StackPanel>
                                    </StackPanel>
                                </GroupBox>
                                <GroupBox Header="Analyze Options M2"
                                          Grid.Column="2"
                                          Margin="0,0,0,12"
                                          DataContext="{Binding RelativeSource={RelativeSource AncestorType={x:Type Window}}}">
                                    <StackPanel Margin="8,4,0,0">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left">
                                            <TextBlock Text="Feature:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <ComboBox x:Name="ComboFeatureM2" Width="138"
                                                      SelectedValuePath="Content"
                                                      SelectedValue="{Binding AnalyzeFeatureM2, Mode=TwoWay}" Height="37">
                                                <ComboBoxItem Content="auto"/>
                                                <ComboBoxItem Content="sift"/>
                                                <ComboBoxItem Content="orb"/>
                                                <ComboBoxItem Content="tm_rot"/>
                                                <ComboBoxItem Content="edges"/>
                                            </ComboBox>
                                        </StackPanel>

                                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Width="221" HorizontalAlignment="Left">
                                            <TextBlock Text="Thershold" VerticalAlignment="Center" Margin="0,0,1,0" Width="63"/>
                                            <TextBox x:Name="TxtThrM2" Width="128"
                                                     Text="{Binding AnalyzeThrM2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Height="37"/>
                                        </StackPanel>
                                    </StackPanel>
                                </GroupBox>
                            </Grid>
                            <GroupBox Header="Analyze Options"
                                      Width="240"
                                      Height="204"
                                      Padding="8,16,8,8"
                                      ScrollViewer.CanContentScroll="True"
                                      DataContext="{Binding RelativeSource={RelativeSource AncestorType={x:Type Window}}}">
                                <StackPanel Margin="8,4,0,0">
                                    <StackPanel Height="102" CanVerticallyScroll="True">
                                        <CheckBox x:Name="ChkDisableRot"
                                                  Content="Disable rot"
                                                  IsChecked="{Binding DisableRot, Mode=TwoWay}"/>
                                        <CheckBox x:Name="ChkScaleLock"
                                                  Content="Lock scale"
                                                  IsChecked="{Binding ScaleLock, Mode=TwoWay}"/>
                                        <CheckBox x:Name="ChkUseLocalMatcher"
                                                  Content="Use local matcher"
                                                  ToolTip="Force local matcher"
                                                  IsChecked="True"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                    </StackPanel>

                    <StackPanel x:Name="InspectionRoisPanel"
                                Visibility="{Binding RoiPanelMode, RelativeSource={RelativeSource AncestorType={x:Type Window}}, Converter={StaticResource RoiPanelModeToVisibility}, ConverterParameter=Inspection}">
                        <StackPanel x:Name="InspectionDefaultPanel">
                            <GroupBox x:Name="InspectionRoisGroup" Header="Inspection ROIs" Margin="0,12,0,0">
                                <StackPanel Margin="8,4,0,0">
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4" VerticalAlignment="Center">
                                        <TextBlock Text="Inspection 1" Width="80" VerticalAlignment="Center"/>
                                        <ComboBox x:Name="CmbShapeInspection1"
                                              Width="80"
                                              Tag="1"
                                              ItemsSource="{Binding AvailableShapes}"
                                              SelectedItem="{Binding DataContext.InspectionRois[0].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                                              SelectionChanged="InspectionShape_SelectionChanged"/>
                                        <ui:Button x:Name="BtnCreateInspection1"
                                               Margin="4,0,0,0"
                                               Style="{StaticResource IconOnlyButton}"
                                               ToolTip="Create ROI 1"
                                               Tag="1"
                                               Click="BtnCreateInspection_Click">
                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.AddSquare24}" FontSize="16"/>
                                        </ui:Button>
                                        <ui:Button Margin="4,0,0,0"
                                               DataContext="{Binding DataContext.InspectionRois[0], ElementName=WorkflowHost}"
                                               Click="BtnToggleEdit_Click"
                                               IsEnabled="{Binding Enabled}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="ToolTip" Value="Edit ROI 1"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection1, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[0].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsEditable}" Value="True">
                                                            <Setter Property="Content">
                                                                <Setter.Value>
                                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" FontSize="16"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="ToolTip" Value="Save ROI 1"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddOkInspection1"
                                               Margin="4,0,0,0"
                                               ToolTip="Add ROI 1 to OK"
                                               Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                                               CommandParameter="{Binding Inspection1}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.CheckmarkCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection1, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[0].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddNgInspection1"
                                               Margin="4,0,0,0"
                                               ToolTip="Add ROI 1 to NG"
                                               Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                                               CommandParameter="{Binding Inspection1}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.DismissCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection1, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[0].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnRemoveInspection1"
                                               Margin="4,0,0,0"
                                               ToolTip="Remove ROI 1"
                                               Click="BtnRemoveInspection1_Click">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection1, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,4" VerticalAlignment="Center">
                                        <TextBlock Text="Inspection 2" Width="80" VerticalAlignment="Center"/>
                                        <ComboBox x:Name="CmbShapeInspection2"
                                          Width="80"
                                          Tag="2"
                                          ItemsSource="{Binding AvailableShapes}"
                                          SelectedItem="{Binding DataContext.InspectionRois[1].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                                          SelectionChanged="InspectionShape_SelectionChanged"/>
                                        <ui:Button x:Name="BtnCreateInspection2"
                                           Margin="4,0,0,0"
                                           Style="{StaticResource IconOnlyButton}"
                                           ToolTip="Create ROI 2"
                                           Tag="2"
                                           Click="BtnCreateInspection_Click">
                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.AddSquare24}" FontSize="16"/>
                                        </ui:Button>
                                        <ui:Button Margin="4,0,0,0"
                                           DataContext="{Binding DataContext.InspectionRois[1], ElementName=WorkflowHost}"
                                           Click="BtnToggleEdit_Click"
                                           IsEnabled="{Binding Enabled}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="ToolTip" Value="Edit ROI 2"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection2, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[1].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsEditable}" Value="True">
                                                            <Setter Property="Content">
                                                                <Setter.Value>
                                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" FontSize="16"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="ToolTip" Value="Save ROI 2"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddOkInspection2"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 2 to OK"
                                           Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection2}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.CheckmarkCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection2, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[1].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddNgInspection2"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 2 to NG"
                                           Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection2}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.DismissCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection2, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[1].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnRemoveInspection2"
                                           Margin="4,0,0,0"
                                           ToolTip="Remove ROI 2"
                                           Click="BtnRemoveInspection2_Click">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection2, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,4" VerticalAlignment="Center">
                                        <TextBlock Text="Inspection 3" Width="80" VerticalAlignment="Center"/>
                                        <ComboBox x:Name="CmbShapeInspection3"
                                          Width="80"
                                          Tag="3"
                                          ItemsSource="{Binding AvailableShapes}"
                                          SelectedItem="{Binding DataContext.InspectionRois[2].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                                          SelectionChanged="InspectionShape_SelectionChanged"/>
                                        <ui:Button x:Name="BtnCreateInspection3"
                                           Margin="4,0,0,0"
                                           Style="{StaticResource IconOnlyButton}"
                                           ToolTip="Create ROI 3"
                                           Tag="3"
                                           Click="BtnCreateInspection_Click">
                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.AddSquare24}" FontSize="16"/>
                                        </ui:Button>
                                        <ui:Button Margin="4,0,0,0"
                                           DataContext="{Binding DataContext.InspectionRois[2], ElementName=WorkflowHost}"
                                           Click="BtnToggleEdit_Click"
                                           IsEnabled="{Binding Enabled}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="ToolTip" Value="Edit ROI 3"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection3, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[2].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsEditable}" Value="True">
                                                            <Setter Property="Content">
                                                                <Setter.Value>
                                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" FontSize="16"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="ToolTip" Value="Save ROI 3"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddOkInspection3"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 3 to OK"
                                           Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection3}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.CheckmarkCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection3, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[2].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddNgInspection3"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 3 to NG"
                                           Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection3}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.DismissCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection3, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[2].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnRemoveInspection3"
                                           Margin="4,0,0,0"
                                           ToolTip="Remove ROI 3"
                                           Click="BtnRemoveInspection3_Click">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection3, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,12" VerticalAlignment="Center">
                                        <TextBlock Text="Inspection 4" Width="80" VerticalAlignment="Center"/>
                                        <ComboBox x:Name="CmbShapeInspection4"
                                          Width="80"
                                          Tag="4"
                                          ItemsSource="{Binding AvailableShapes}"
                                          SelectedItem="{Binding DataContext.InspectionRois[3].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                                          SelectionChanged="InspectionShape_SelectionChanged"/>
                                        <ui:Button x:Name="BtnCreateInspection4"
                                           Margin="4,0,0,0"
                                           Style="{StaticResource IconOnlyButton}"
                                           ToolTip="Create ROI 4"
                                           Tag="4"
                                           Click="BtnCreateInspection_Click">
                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.AddSquare24}" FontSize="16"/>
                                        </ui:Button>
                                        <ui:Button Margin="4,0,0,0"
                                           DataContext="{Binding DataContext.InspectionRois[3], ElementName=WorkflowHost}"
                                           Click="BtnToggleEdit_Click"
                                           IsEnabled="{Binding Enabled}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Edit24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="ToolTip" Value="Edit ROI 4"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection4, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[3].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsEditable}" Value="True">
                                                            <Setter Property="Content">
                                                                <Setter.Value>
                                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Save24}" FontSize="16"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="ToolTip" Value="Save ROI 4"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddOkInspection4"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 4 to OK"
                                           Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection4}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.CheckmarkCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection4, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[3].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnAddNgInspection4"
                                           Margin="4,0,0,0"
                                           ToolTip="Add ROI 4 to NG"
                                           Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                                           CommandParameter="{Binding Inspection4}">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.DismissCircle24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection4, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding DataContext.InspectionRois[3].Enabled, ElementName=WorkflowHost}" Value="False">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                        <ui:Button x:Name="BtnRemoveInspection4"
                                           Margin="4,0,0,0"
                                           ToolTip="Remove ROI 4"
                                           Click="BtnRemoveInspection4_Click">
                                            <ui:Button.Style>
                                                <Style TargetType="{x:Type ui:Button}" BasedOn="{StaticResource IconOnlyButtonStyle}">
                                                    <Setter Property="IsEnabled" Value="True"/>
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Delete24}" FontSize="16"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.Inspection4, ElementName=WorkflowHost}" Value="{x:Null}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:Button.Style>
                                        </ui:Button>
                                    </StackPanel>

                                    <workflow:WorkflowControl x:Name="WorkflowHost"
                                                              ShowInspectionDatasetSection="False"
                                                              Margin="0,12,0,0"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>

                        <StackPanel x:Name="InspectionDatasetPanel" Visibility="Collapsed" Margin="0,12,0,0">
                            <workflow:InspectionDatasetTabsControl x:Name="InspectionDatasetTabsHost"
                                                                   DataContext="{Binding ElementName=WorkflowHost, Path=DataContext}"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <ScrollViewer x:Name="BatchInspectionPanel" Grid.Row="1" VerticalScrollBarVisibility="Auto" Visibility="Collapsed" d:Visibility="Collapsed" DataContext="{Binding DataContext, ElementName=WorkflowHost}">
                <Grid Margin="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Margin="8">
                        <TextBox Width="315"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto"
                                 Text="{Binding BatchFolder, UpdateSourceTrigger=PropertyChanged}"/>
                        <ui:Button Margin="8,0,0,0"
                                   Padding="12,4"
                                   Command="{Binding BrowseBatchFolderCommand}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.FolderOpen24}" Margin="0,0,8,0" FontSize="16"/>
                                <TextBlock Text="Browse" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ui:Button>

                        <!-- â¶ Play = Start/Resume -->
                        <ui:Button Style="{StaticResource IconOnlyButton}"
                                   ToolTip="Play / Start or Resume"
                                   AutomationProperties.Name="Play"
                                   Command="{Binding StartBatchCommand}">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Play24}" FontSize="16"/>
                        </ui:Button>

                        <!-- â¸ Pause -->
                        <ui:Button Style="{StaticResource IconOnlyButton}"
                                   ToolTip="Pause"
                                   AutomationProperties.Name="Pause"
                                   Command="{Binding PauseBatchCommand}">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Pause24}" FontSize="16"/>
                        </ui:Button>

                        <!-- â  Stop -->
                        <ui:Button Style="{StaticResource IconOnlyButton}"
                                   ToolTip="Stop"
                                   AutomationProperties.Name="Stop"
                                   Command="{Binding StopBatchCommand}">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Stop24}" FontSize="16"/>
                        </ui:Button>

                        <TextBlock Margin="12,0,0,0"
                                   VerticalAlignment="Center"
                                   Text="{Binding BatchSummary}"/>
                    </StackPanel>

                    <StackPanel Grid.Row="1" Margin="8" Orientation="Vertical">
                        <TextBlock Text="Heatmap cutoff (%)"/>
                        <Slider Minimum="0"
                                Maximum="100"
                                TickFrequency="5"
                                IsSnapToTickEnabled="True"
                                Value="{Binding HeatmapCutoffPercent, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <TextBlock Margin="0,8,0,8"
                                   Text="{Binding HeatmapInfo}"/>

                        <TextBlock Text="Delay per ROI (seconds)"/>
                        <Slider Minimum="0"
                                Maximum="10"
                                TickFrequency="0.1"
                                IsSnapToTickEnabled="True"
                                Value="{Binding BatchPausePerRoiSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <TextBlock Margin="0,4,0,0"
                                   Text="{Binding BatchPausePerRoiSeconds, StringFormat=Delay: \{0:0.0\}s}"/>
                    </StackPanel>

                    <Grid Grid.Row="2" Margin="8" x:Name="BatchGrid"
                          Loaded="BatchGrid_Loaded"
                          DataContextChanged="BatchGrid_DataContextChanged">
                        <!-- Imagen base -->
                        <Image x:Name="BaseImage"
                               Source="{Binding BatchImageSource}"
                               Stretch="Uniform"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               SnapsToDevicePixels="True"
                               RenderOptions.BitmapScalingMode="HighQuality"
                               Panel.ZIndex="0"/>

                        <!-- Overlay exactamente encima del rectÃ¡ngulo visible de BaseImage -->
                        <Canvas x:Name="Overlay"
                                Width="{Binding ActualWidth, ElementName=BaseImage}"
                                Height="{Binding ActualHeight, ElementName=BaseImage}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                IsHitTestVisible="False"
                                Panel.ZIndex="1">
                            <!-- Heatmap del ROI: se posiciona y escala desde cÃ³digo -->
                            <Image x:Name="HeatmapImage"
                                   Stretch="Fill"
                                   Opacity="0.65"
                                   SnapsToDevicePixels="True"
                                   UseLayoutRounding="True"
                                   RenderOptions.BitmapScalingMode="HighQuality"/>
                        </Canvas>
                    </Grid>

                    <DataGrid Grid.Row="3"
                              Margin="8"
                              ItemsSource="{Binding BatchRows}"
                              AutoGenerateColumns="False"
                              HeadersVisibility="Column"
                              IsReadOnly="True"
                              CanUserAddRows="False"
                              RowHeaderWidth="0">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="File" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FileName}"
                                                   Cursor="Hand"
                                                   TextDecorations="Underline"
                                                   MouseLeftButtonUp="BatchFile_Click"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ROI 1" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="18" Height="18"
                                                 Fill="{Binding ROI1, Converter={StaticResource BatchCellStatusToBrush}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ROI 2" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="18" Height="18"
                                                 Fill="{Binding ROI2, Converter={StaticResource BatchCellStatusToBrush}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ROI 3" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="18" Height="18"
                                                 Fill="{Binding ROI3, Converter={StaticResource BatchCellStatusToBrush}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ROI 4" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Ellipse Width="18" Height="18"
                                                 Fill="{Binding ROI4, Converter={StaticResource BatchCellStatusToBrush}}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <TextBlock Grid.Row="4"
                               Margin="8"
                               Text="{Binding BatchStatus}"/>
                </Grid>
            </ScrollViewer>

            <ScrollViewer x:Name="CommsPanel" Grid.Row="1" VerticalScrollBarVisibility="Auto" Visibility="Collapsed" d:Visibility="Collapsed">
                <Grid Margin="8" x:Name="CommsRoot">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,12">
                        <TextBlock Text="PLC IP:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                        <TextBox Width="130"
                                 Text="{Binding PlcIpAddress, UpdateSourceTrigger=PropertyChanged}"/>

                        <TextBlock Text="Rack:" VerticalAlignment="Center" Margin="8,0,4,0"/>
                        <TextBox Width="40"
                                 Text="{Binding Rack}" IsReadOnly="True"/>

                        <TextBlock Text="Slot:" VerticalAlignment="Center" Margin="8,0,4,0"/>
                        <TextBox Width="40"
                                 Text="{Binding Slot}" IsReadOnly="True"/>

                        <ui:Button Margin="12,0,0,0"
                                   Padding="10,3"
                                   Command="{Binding ConnectCommand}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.PlugConnected24}" Margin="0,0,8,0" FontSize="16"/>
                                <TextBlock Text="Connect" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ui:Button>

                        <ui:Button Margin="4,0,0,0"
                                   Padding="10,3"
                                   Command="{Binding DisconnectCommand}">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.PlugDisconnected24}" Margin="0,0,8,0" FontSize="16"/>
                                <TextBlock Text="Disconnect" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ui:Button>

                        <TextBlock Margin="12,0,0,0"
                                   VerticalAlignment="Center"
                                   Text="{Binding ConnectionStatus}"/>
                    </StackPanel>

                    <Grid Grid.Row="1">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <GroupBox Header="Backend" Grid.ColumnSpan="2" Margin="0,0,0,12"
                                  DataContext="{Binding DataContext, ElementName=WorkflowHost}">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Text="Role" VerticalAlignment="Center"/>
                                <TextBox Grid.Column="1" Margin="8,0" Width="160"
                                         Text="{Binding RoleId, UpdateSourceTrigger=PropertyChanged}"/>

                                <TextBlock Grid.Row="1" Text="ROI" VerticalAlignment="Center"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Margin="8,4,8,0" Width="160"
                                         Text="{Binding RoiId, UpdateSourceTrigger=PropertyChanged}"/>

                                <TextBlock Grid.Row="2" Text="Backend" VerticalAlignment="Center"/>
                                <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="8,4,8,0">
                                    <TextBox Width="260" Margin="0,0,8,0"
                                             Text="{Binding BackendBaseUrl, UpdateSourceTrigger=PropertyChanged}"/>
                                    <ui:Button Padding="12,4"
                                               Command="{Binding RefreshHealthCommand}">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Pulse24}" Margin="0,0,8,0"/>
                                            <TextBlock Text="Health" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </ui:Button>
                                </StackPanel>

                                <TextBlock Grid.Row="2" Grid.Column="2" Margin="8,4,0,0"
                                           Text="{Binding HealthSummary}" TextWrapping="Wrap" Width="200"/>
                            </Grid>
                        </GroupBox>

                        <GroupBox Header="Inputs" Grid.Row="1" Grid.Column="0" Margin="0,0,8,0">
                            <ItemsControl ItemsSource="{Binding Inputs}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <DockPanel Margin="0,2">
                                            <Ellipse Width="16" Height="16"
                                                     Margin="0,0,6,0"
                                                     Fill="{Binding IsOn, Converter={StaticResource BoolToBrush}}"/>
                                            <TextBlock Text="{Binding DisplayName}"
                                                       VerticalAlignment="Center"
                                                       Width="140"/>
                                            <ui:Button Margin="8,0,0,0"
                                                       Padding="6,2"
                                                       Command="{Binding DataContext.ToggleInputCommand, RelativeSource={RelativeSource AncestorType={x:Type GroupBox}}}"
                                                       CommandParameter="{Binding Id}">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Power24}" Margin="0,0,6,0" FontSize="16"/>
                                                    <TextBlock Text="Enable" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </ui:Button>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </GroupBox>

                        <GroupBox Header="Outputs" Grid.Row="1" Grid.Column="1">
                            <ItemsControl ItemsSource="{Binding Outputs}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <DockPanel Margin="0,2">
                                            <Ellipse Width="16" Height="16"
                                                     Margin="0,0,6,0"
                                                     Fill="{Binding IsOn, Converter={StaticResource BoolToBrush}}"/>
                                            <TextBlock Text="{Binding DisplayName}"
                                                       VerticalAlignment="Center"
                                                       Width="140"/>
                                            <ui:Button Margin="8,0,0,0"
                                                       Padding="6,2"
                                                       Command="{Binding DataContext.ToggleOutputCommand, RelativeSource={RelativeSource AncestorType={x:Type GroupBox}}}"
                                                       CommandParameter="{Binding Id}">
                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Power24}" Margin="0,0,6,0" FontSize="16"/>
                                                    <TextBlock Text="Enable" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </ui:Button>
                                        </DockPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </GroupBox>
                    </Grid>
                </Grid>
            </ScrollViewer>
        </Grid>
        <Border Grid.Row="1" Grid.Column="0"
            BorderBrush="#D0D0D0" BorderThickness="0,0,1,0"
            Background="#F7F7F7">
            <StackPanel Margin="8">
                <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                           Click="NavLayoutSetup_Click">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Settings24}" FontSize="18" Margin="0,0,10,0"/>
                        <TextBlock Text="Layout Setup" VerticalAlignment="Center"/>
                    </StackPanel>
                </ui:Button>
                <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                           Click="NavRoiManagement_Click">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Crop24}" FontSize="18" Margin="0,0,10,0"/>
                        <TextBlock Text="ROIs Management" VerticalAlignment="Center"/>
                    </StackPanel>
                </ui:Button>
                <!-- SubmenÃº colapsable: mismo tamaÃ±o/estilo que el resto, con tabulaciÃ³n -->
                <StackPanel x:Name="RoiNavSubmenu" Visibility="Collapsed" Margin="0">
                    <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                               Click="RoiManagementSelectMaster_Click">
                        <!-- TabulaciÃ³n: indentamos SOLO el contenido para mantener mismo ancho/alineaciÃ³n del botÃ³n -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="22,0,0,0">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Target24}" FontSize="18" Margin="0,0,10,0"/>
                            <TextBlock Text="Master ROIs" VerticalAlignment="Center"/>
                        </StackPanel>
                    </ui:Button>

                    <!-- Sub-submenÃº: visible solo cuando se selecciona Master ROIs -->
                    <StackPanel x:Name="MasterRoiSubmenu" Visibility="Collapsed" Margin="0">
                        <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                                   Click="NavMasterAdvanced_Click">
                            <!-- tabulaciÃ³n para subnivel -->
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="40,0,0,0">
                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Settings24}" FontSize="18" Margin="0,0,10,0"/>
                                <TextBlock Text="Advanced" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ui:Button>
                    </StackPanel>

                    <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                               Click="RoiManagementSelectInspection_Click">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="22,0,0,0">
                            <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.Scan24}" FontSize="18" Margin="0,0,10,0"/>
                            <TextBlock Text="Inspection ROIs" VerticalAlignment="Center"/>
                        </StackPanel>
                    </ui:Button>

                    <StackPanel x:Name="InspectionRoiSubmenu" Visibility="Collapsed" Margin="0">
                        <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                                   Click="RoiManagementInspectionDataset_Click">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="40,0,0,0">
                                <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.FolderOpen24}" FontSize="18" Margin="0,0,10,0"/>
                                <TextBlock Text="Dataset" VerticalAlignment="Center"/>
                            </StackPanel>
                        </ui:Button>
                    </StackPanel>
                </StackPanel>
                <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                           Click="NavBatchInspection_Click">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.PlayCircle24}" FontSize="18" Margin="0,0,10,0"/>
                        <TextBlock Text="Batch Inspection" VerticalAlignment="Center"/>
                    </StackPanel>
                </ui:Button>
                <ui:Button Style="{StaticResource LeftNavButtonStyle}"
                           Click="NavComms_Click"
                           Margin="0">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:SymbolIcon Symbol="{x:Static ui:SymbolRegular.PlugConnected24}" FontSize="18" Margin="0,0,10,0"/>
                        <TextBlock Text="Comms" VerticalAlignment="Center"/>
                    </StackPanel>
                </ui:Button>
            </StackPanel>
        </Border>

        <GridSplitter Grid.Row="1" Grid.Column="2" Style="{StaticResource PanelGridSplitterStyle}" ShowsPreview="True" ResizeBehavior="PreviousAndNext" DragCompleted="PanelSplitter_OnDragCompleted" />

        <!-- ===== Viewer/Canvas (right) ===== -->
        <Grid Grid.Column="3" Grid.Row="1" x:Name="ViewerHost">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <AdornerDecorator Grid.Row="1" Margin="0,8,0,0">
                    <Grid Background="#111">
                        <Grid>
                            <Image x:Name="ImgMain" Stretch="Uniform" Panel.ZIndex="0" />
                            <Image x:Name="HeatmapOverlay"
                       IsHitTestVisible="False"
                       Stretch="Fill"
                       HorizontalAlignment="Left"
                       VerticalAlignment="Top"
                       SnapsToDevicePixels="True"
                       Opacity="{Binding HeatmapOverlayOpacity, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                       Visibility="Collapsed"
                       Panel.ZIndex="1"/>
                            <Canvas x:Name="CanvasROI"
                        Background="Transparent"
                        IsHitTestVisible="True"
                       Panel.ZIndex="2"/>
                            <local:RoiOverlay x:Name="RoiOverlay"
                                  Visibility="Collapsed"
                                  IsHitTestVisible="False"
                                  Panel.ZIndex="3"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch"/>
                        </Grid>
                    </Grid>
                </AdornerDecorator>

                <Border x:Name="SnackPanel"
                  Grid.Row="1"
                  Grid.RowSpan="3"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Top"
                  Margin="0,12,0,0"
                  Padding="10,6"
                  Background="#F22C2C2C"
                  CornerRadius="6"
                  Visibility="Collapsed"
                  Panel.ZIndex="900"
                  IsHitTestVisible="False">
                    <TextBlock x:Name="SnackText"
                       Foreground="White"
                       FontWeight="SemiBold"
                       TextWrapping="Wrap"
                       MaxWidth="520"/>
                </Border>

                <!-- ===== HUD: ROI list (top-left) ===== -->
                <Grid x:Name="RoiHudOverlay"
                Grid.Row="1"
                VerticalAlignment="Top"
                HorizontalAlignment="Left"
                Margin="12,8,0,0"
                Panel.ZIndex="400"
                IsHitTestVisible="True"
                Visibility="Collapsed">
                    <Border x:Name="RoiHudPanel"
                      Background="#CC1A1A1A"
                      BorderBrush="#39FF14"
                      BorderThickness="1.2"
                      CornerRadius="8"
                      Padding="10">
                        <Border.Effect>
                            <DropShadowEffect Color="#AA000000"
                                    BlurRadius="8"
                                    ShadowDepth="0" />
                        </Border.Effect>
                        <StackPanel x:Name="RoiHudStack" />
                    </Border>
                </Grid>

                <Border x:Name="RoiVisibilityPanel"
                  Grid.Row="2"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Center"
                  Margin="12,8,12,12"
                  Padding="10,8"
                  Background="#CC1E1E1E"
                  CornerRadius="8"
                  Panel.ZIndex="1"
                  DataContext="{Binding DataContext, ElementName=WorkflowHost}">
                    <StackPanel Orientation="Horizontal">
                        <StackPanel.Resources>
                            <Style TargetType="{x:Type Button}">
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                            <Style TargetType="{x:Type ToggleButton}">
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                            <Style TargetType="{x:Type CheckBox}">
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                            <Style TargetType="{x:Type TextBlock}">
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                        </StackPanel.Resources>
                        <CheckBox x:Name="ChkShowMaster1Pattern"
                        IsChecked="{Binding ShowMaster1Pattern}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                                <TextBlock Text="Master 1"/>
                            </StackPanel>
                        </CheckBox>
                        <CheckBox x:Name="ChkShowMaster1Inspection"
                        IsChecked="{Binding ShowMaster1Inspection}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                                <TextBlock Text="Search 1"/>
                            </StackPanel>
                        </CheckBox>
                        <CheckBox x:Name="ChkShowMaster2Pattern"
                        IsChecked="{Binding ShowMaster2Pattern}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                                <TextBlock Text="Master 2"/>
                            </StackPanel>
                        </CheckBox>
                        <CheckBox x:Name="ChkShowMaster2Inspection"
                        IsChecked="{Binding ShowMaster2Inspection}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                                <TextBlock Text="Search 2"/>
                            </StackPanel>
                        </CheckBox>
                        <CheckBox x:Name="ChkShowInspectionRoi"
                        IsChecked="{Binding ShowInspectionRoi}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                                <TextBlock Text="Inspection"/>
                            </StackPanel>
                        </CheckBox>
                    </StackPanel>
                </Border>
            </Grid>
            <Grid x:Name="DiskStatusHUD"
              HorizontalAlignment="Right"
              VerticalAlignment="Top"
              Margin="12"
              Panel.ZIndex="950"
              Visibility="Collapsed"
              IsHitTestVisible="False">
                <Border x:Name="DiskStatusPanel"
                  Background="#CC000000"
                  BorderBrush="#39FF14"
                  BorderThickness="1.5"
                  CornerRadius="0"
                  Padding="8">
                    <TextBlock x:Name="DiskStatusText"
                       Text=""
                       FontFamily="Segoe UI"
                       FontWeight="Bold"
                       FontSize="22"
                       Foreground="White"/>
                </Border>
            </Grid>
            <!-- ===== HUD: bottom-right Heatmap controls ===== -->
            <Grid x:Name="HudOverlay" Panel.ZIndex="1000" IsHitTestVisible="True">
                <Border x:Name="HeatmapHUD"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Bottom"
                  Margin="16"
                  Background="#CC0F0F0F"
                  CornerRadius="8"
                  Padding="10"
                  IsHitTestVisible="True">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <CheckBox x:Name="ChkHeatmap"
                        Content="Heatmap"
                        IsChecked="True"
                        Margin="0,0,8,0"/>
                        <TextBlock x:Name="ResultLabel"
                         Text="Result: --"
                         Foreground="LightGreen"
                         FontFamily="Segoe UI"
                         FontWeight="SemiBold"
                         Margin="0,0,8,0"/>
                        <TextBlock x:Name="HeatmapScaleLabel"
                         Text="Heatmap Scale: 1.00"
                         Foreground="#39FF14"
                         FontFamily="Segoe UI"
                         FontWeight="SemiBold"
                         Margin="0,0,8,0"/>
                        <Slider x:Name="HeatmapScaleSlider"
                      Width="160"
                      Minimum="0.10"
                      Maximum="2.00"
                      Value="1.00"
                      Margin="0,0,12,0"/>
                        <TextBlock Text="Opacity"
                         Foreground="#39FF14"
                         FontFamily="Segoe UI"
                         FontWeight="SemiBold"
                         Margin="0,0,8,0"/>
                        <Slider x:Name="HeatmapOpacitySlider"
                      Width="140"
                      Minimum="0"
                      Maximum="1"
                      TickFrequency="0.05"
                      IsSnapToTickEnabled="True"
                      Value="{Binding HeatmapOverlayOpacity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
        <Border Grid.Row="2" Grid.ColumnSpan="4" Padding="12,10" Background="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}" BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="{DynamicResource StatusBackend}" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding DataContext.HealthSummary, ElementName=WorkflowHost}" Margin="6,0,0,0" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="{DynamicResource StatusMode}" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding ModeStatusText, RelativeSource={RelativeSource AncestorType={x:Type Window}}}" Margin="6,0,0,0" />
                </StackPanel>

                <StackPanel Orientation="Horizontal" Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <ui:ProgressRing Width="18" Height="18" IsIndeterminate="{Binding DataContext.IsBusy, ElementName=WorkflowHost}" Margin="0,0,8,0" />
                    <TextBlock Text="{Binding BusyStatusText, RelativeSource={RelativeSource AncestorType={x:Type Window}}}" />
                </StackPanel>
            </Grid>
        </Border>

        <Grid x:Name="BusyOverlay"
              Background="#66000000"
              Visibility="Collapsed"
              Panel.ZIndex="999"
              Grid.RowSpan="3"
              Grid.ColumnSpan="4">
            <Border Width="360"
                  Padding="18"
                  Background="White"
                  CornerRadius="12"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center">
                <StackPanel>
                    <TextBlock x:Name="BusyTitleText"
                         Text="Working..."
                         FontSize="20"
                         FontWeight="SemiBold"
                         Margin="0,0,0,12"/>
                    <ProgressBar x:Name="BusyProgress"
                           Height="6"
                           Width="260"
                           IsIndeterminate="True"/>
                    <TextBlock Text="Please wait..."
                         FontSize="12"
                         Margin="0,12,0,0"
                         Opacity="0.7"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
