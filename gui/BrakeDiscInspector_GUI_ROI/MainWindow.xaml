<Window x:Class="BrakeDiscInspector_GUI_ROI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:BrakeDiscInspector_GUI_ROI"
        xmlns:m="clr-namespace:BrakeDiscInspector_GUI_ROI.Models"
        xmlns:workflow="clr-namespace:BrakeDiscInspector_GUI_ROI.Workflow"
        xmlns:conv="clr-namespace:BrakeDiscInspector_GUI_ROI.Converters"
        Title="BrakeDiscInspector"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        Background="#0E0E10"
        UseLayoutRounding="True"
        Loaded="MainWindow_Loaded">

  <Window.Resources>
    <conv:BoolToEditSaveTextConverter x:Key="BoolToEditSaveText" />
    <Style x:Key="ForegroundWhiteStyle" TargetType="{x:Type StackPanel}">
      <Setter Property="TextElement.Foreground" Value="White"/>
    </Style>
  </Window.Resources>

  <Grid x:Name="RootGrid">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="*" />
      <ColumnDefinition x:Name="SidePanelColumn" Width="840" MinWidth="840" />
    </Grid.ColumnDefinitions>

    <!-- ===== Tabs (left) ===== -->
    <TabControl Grid.Row="1" Grid.Column="1" x:Name="MainTabs" TabStripPlacement="Left">
      <TabItem x:Name="TabSetupInspect" Header="Preparación &amp; Inspección">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel x:Name="SetupInspectRoot" Margin="8" Orientation="Vertical">
            <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
              <Button x:Name="BtnLoadImage"
                      Content="Load Picture"
                      Margin="0,0,8,0"
                      MinWidth="120"
                      ToolTip="Abrir una imagen"
                      Click="BtnLoadImage_Click"/>
              <Button x:Name="BtnLoadLayout"
                      Content="Load Layout"
                      Margin="0,0,8,0"
                      MinWidth="120"
                      Click="BtnLoadLayout_Click"/>
              <Button x:Name="BtnSaveLayout"
                      Content="Save Layout"
                      MinWidth="120"
                      Click="BtnSaveLayout_Click"/>
            </StackPanel>

            <GroupBox x:Name="Master1EditorGroup" Header="Master 1">
              <StackPanel Margin="0,8,0,0">
                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="Tipo:" Grid.Column="0" VerticalAlignment="Center"/>
                  <ComboBox x:Name="ComboMasterRoiRole" Grid.Column="1" Margin="0,4,0,0"/>
                </Grid>

                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="Forma:" Grid.Column="0" VerticalAlignment="Center"/>
                  <ComboBox x:Name="ComboMasterRoiShape" Grid.Column="1" Margin="0,4,0,0">
                    <ComboBoxItem Content="Rectángulo"/>
                    <ComboBoxItem Content="Círculo"/>
                    <ComboBoxItem Content="Annulus"/>
                  </ComboBox>
                </Grid>

                <WrapPanel>
                  <Button x:Name="BtnSaveMaster"
                          Content="Save Master 1"
                          Margin="0,0,8,0"
                          MinWidth="120"
                          Click="BtnSaveMaster_Click"/>
                  <Button x:Name="BtnValidateM1"
                          Content="Validar Master 1"
                          MinWidth="120"
                          Click="BtnValidateM1_Click"/>
                </WrapPanel>

                <Border Margin="0,12,0,0" Background="#11000000" Padding="8">
                  <TextBlock x:Name="TxtMasterHints" TextWrapping="Wrap"/>
                </Border>
              </StackPanel>
            </GroupBox>

            <GroupBox Header="Master 2" Margin="0,10,0,0">
              <StackPanel Margin="0,8,0,0">
                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="Tipo:" Grid.Column="0" VerticalAlignment="Center"/>
                  <ComboBox x:Name="ComboM2Role" Grid.Column="1" Margin="0,4,0,0"/>
                </Grid>

                <Grid Margin="0,0,0,8">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                  </Grid.ColumnDefinitions>
                  <TextBlock Text="Forma:" Grid.Column="0" VerticalAlignment="Center"/>
                  <ComboBox x:Name="ComboM2Shape" Grid.Column="1" Margin="0,4,0,0">
                    <ComboBoxItem Content="Rectángulo"/>
                    <ComboBoxItem Content="Círculo"/>
                    <ComboBoxItem Content="Annulus"/>
                  </ComboBox>
                </Grid>

                <WrapPanel>
                  <Button Content="Save Master 2"
                          Margin="0,0,8,0"
                          MinWidth="120"
                          Click="BtnSaveMaster_Click"/>
                  <Button x:Name="BtnValidateM2"
                          Content="Validar Master 2"
                          MinWidth="120"
                          Click="BtnValidateM2_Click"/>
                </WrapPanel>
              </StackPanel>
            </GroupBox>

            <WrapPanel Margin="0,12,0,12">
              <Button x:Name="BtnClearCanvas"
                      Content="Borrar Canvas"
                      MinWidth="150"
                      Click="BtnClearCanvas_Click"/>
            </WrapPanel>

            <GroupBox Header="Analyze options" Margin="0,0,0,12">
              <StackPanel Margin="8,4,0,0">
                <StackPanel Orientation="Horizontal">
                  <CheckBox x:Name="ChkScaleLock"
                            Content="Lock scale"
                            IsChecked="{Binding ScaleLock, Mode=TwoWay}"/>
                  <CheckBox x:Name="ChkUseLocalMatcher"
                            Content="Use local matcher"
                            Margin="16,0,0,0"
                            ToolTip="Forzar matcher local"
                            IsChecked="True"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                  <TextBlock Text="Position tolerance (px)"
                             Width="180"
                             VerticalAlignment="Center"/>
                  <TextBox Width="80"
                           Margin="0,0,8,0"
                           Text="{Binding AnalyzePosTolerancePx, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                  <TextBlock Text="Angle tolerance (deg)"
                             Width="180"
                             VerticalAlignment="Center"/>
                  <TextBox Width="80"
                           Text="{Binding AnalyzeAngToleranceDeg, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F2}}"/>
                </StackPanel>
                <Button x:Name="BtnAnalyzeMaster"
                        Content="Force Analyze Master"
                        Margin="0,12,0,0"
                        MinWidth="160"
                        Click="BtnAnalyzeMaster_Click"/>
              </StackPanel>
            </GroupBox>

            <TextBlock Text="Feature (sin geom):"/>
            <ComboBox x:Name="ComboFeature" Margin="0,4,0,8">
              <ComboBoxItem Content="auto"/>
              <ComboBoxItem Content="sift"/>
              <ComboBoxItem Content="orb"/>
              <ComboBoxItem Content="tm_rot"/>
            </ComboBox>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
              <TextBlock Text="Thr:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtThr" Width="60" Margin="6,0,16,0" Text="85"/>
              <TextBlock Text="RotRange:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtRot" Width="60" Margin="6,0,16,0" Text="10"/>
              <TextBlock Text="ScaleMin:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMin" Width="60" Margin="6,0,16,0" Text="0.95"/>
              <TextBlock Text="ScaleMax:" VerticalAlignment="Center"/>
              <TextBox x:Name="TxtSMax" Width="60" Margin="6,0,0,0" Text="1.05"/>
            </StackPanel>
            <WrapPanel>
              <Button x:Name="BtnSavePreset" Content="Guardar Preset" Click="BtnSavePreset_Click" Margin="0,0,8,0"/>
            </WrapPanel>

            <TextBlock x:Name="ResultLabel"
                       Text="Sin resultado"
                       FontSize="16"
                       FontWeight="Bold"
                       Foreground="#ddd"
                       Margin="0,12,0,0"/>

            <GroupBox x:Name="InspectionRoisGroup" Header="Inspection ROIs" Margin="0,12,0,0">
              <StackPanel Margin="8,4,0,0">
                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                  <TextBlock Text="Inspection 1" Width="120" VerticalAlignment="Center"/>
                  <ComboBox x:Name="CmbShapeInspection1"
                            Width="130"
                            Tag="1"
                            ItemsSource="{Binding AvailableShapes}"
                            SelectedItem="{Binding DataContext.InspectionRois[0].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                            SelectionChanged="InspectionShape_SelectionChanged"/>
                  <Button x:Name="BtnCreateInspection1"
                          Margin="8,0,0,0"
                          MinWidth="90"
                          MinHeight="28"
                          Tag="1"
                          Click="BtnCreateInspection_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Create ROI" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnSaveInspection1"
                          Margin="8,0,0,0"
                          MinWidth="110"
                          MinHeight="28"
                          Click="BtnSaveInspection1_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Inspection 1" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnAddOkInspection1"
                          Margin="8,0,0,0"
                          Content="Add to OK"
                          Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection1}"/>
                  <Button x:Name="BtnAddNgInspection1"
                          Margin="8,0,0,0"
                          Content="Add to NG"
                          Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection1}"/>
                  <Button x:Name="BtnRemoveInspection1"
                          Margin="8,0,0,0"
                          Content="Remove 1"
                          Click="BtnRemoveInspection1_Click">
                    <Button.Style>
                      <Style TargetType="Button">
                        <Setter Property="IsEnabled" Value="True"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding DataContext.Inspection1, ElementName=WorkflowHost}" Value="{x:Null}">
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Button.Style>
                  </Button>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,4,0,4">
                  <TextBlock Text="Inspection 2" Width="120" VerticalAlignment="Center"/>
                  <ComboBox x:Name="CmbShapeInspection2"
                            Width="130"
                            Tag="2"
                            ItemsSource="{Binding AvailableShapes}"
                            SelectedItem="{Binding DataContext.InspectionRois[1].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                            SelectionChanged="InspectionShape_SelectionChanged"/>
                  <Button x:Name="BtnCreateInspection2"
                          Margin="8,0,0,0"
                          MinWidth="90"
                          MinHeight="28"
                          Tag="2"
                          Click="BtnCreateInspection_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Create ROI" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnSaveInspection2"
                          Margin="8,0,0,0"
                          MinWidth="110"
                          MinHeight="28"
                          Click="BtnSaveInspection2_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Inspection 2" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnAddOkInspection2"
                          Margin="8,0,0,0"
                          Content="Add to OK"
                          Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection2}"/>
                  <Button x:Name="BtnAddNgInspection2"
                          Margin="8,0,0,0"
                          Content="Add to NG"
                          Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection2}"/>
                  <Button x:Name="BtnRemoveInspection2"
                          Margin="8,0,0,0"
                          Content="Remove 2"
                          Click="BtnRemoveInspection2_Click">
                    <Button.Style>
                      <Style TargetType="Button">
                        <Setter Property="IsEnabled" Value="True"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding DataContext.Inspection2, ElementName=WorkflowHost}" Value="{x:Null}">
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Button.Style>
                  </Button>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,4,0,4">
                  <TextBlock Text="Inspection 3" Width="120" VerticalAlignment="Center"/>
                  <ComboBox x:Name="CmbShapeInspection3"
                            Width="130"
                            Tag="3"
                            ItemsSource="{Binding AvailableShapes}"
                            SelectedItem="{Binding DataContext.InspectionRois[2].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                            SelectionChanged="InspectionShape_SelectionChanged"/>
                  <Button x:Name="BtnCreateInspection3"
                          Margin="8,0,0,0"
                          MinWidth="90"
                          MinHeight="28"
                          Tag="3"
                          Click="BtnCreateInspection_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Create ROI" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnSaveInspection3"
                          Margin="8,0,0,0"
                          MinWidth="110"
                          MinHeight="28"
                          Click="BtnSaveInspection3_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Inspection 3" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnAddOkInspection3"
                          Margin="8,0,0,0"
                          Content="Add to OK"
                          Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection3}"/>
                  <Button x:Name="BtnAddNgInspection3"
                          Margin="8,0,0,0"
                          Content="Add to NG"
                          Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection3}"/>
                  <Button x:Name="BtnRemoveInspection3"
                          Margin="8,0,0,0"
                          Content="Remove 3"
                          Click="BtnRemoveInspection3_Click">
                    <Button.Style>
                      <Style TargetType="Button">
                        <Setter Property="IsEnabled" Value="True"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding DataContext.Inspection3, ElementName=WorkflowHost}" Value="{x:Null}">
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Button.Style>
                  </Button>
                </StackPanel>

                <StackPanel Orientation="Horizontal" Margin="0,4,0,12">
                  <TextBlock Text="Inspection 4" Width="120" VerticalAlignment="Center"/>
                  <ComboBox x:Name="CmbShapeInspection4"
                            Width="130"
                            Tag="4"
                            ItemsSource="{Binding AvailableShapes}"
                            SelectedItem="{Binding DataContext.InspectionRois[3].Shape, ElementName=WorkflowHost, Mode=TwoWay}"
                            SelectionChanged="InspectionShape_SelectionChanged"/>
                  <Button x:Name="BtnCreateInspection4"
                          Margin="8,0,0,0"
                          MinWidth="90"
                          MinHeight="28"
                          Tag="4"
                          Click="BtnCreateInspection_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Create ROI" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnSaveInspection4"
                          Margin="8,0,0,0"
                          MinWidth="110"
                          MinHeight="28"
                          Click="BtnSaveInspection4_Click">
                    <Button.Content>
                      <StackPanel Orientation="Horizontal" Style="{StaticResource ForegroundWhiteStyle}">
                        <TextBlock Text="Inspection 4" FontWeight="SemiBold"/>
                      </StackPanel>
                    </Button.Content>
                  </Button>
                  <Button x:Name="BtnAddOkInspection4"
                          Margin="8,0,0,0"
                          Content="Add to OK"
                          Command="{Binding DataContext.AddRoiToOkCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection4}"/>
                  <Button x:Name="BtnAddNgInspection4"
                          Margin="8,0,0,0"
                          Content="Add to NG"
                          Command="{Binding DataContext.AddRoiToNgCommand, ElementName=WorkflowHost}"
                          CommandParameter="{Binding Inspection4}"/>
                  <Button x:Name="BtnRemoveInspection4"
                          Margin="8,0,0,0"
                          Content="Remove 4"
                          Click="BtnRemoveInspection4_Click">
                    <Button.Style>
                      <Style TargetType="Button">
                        <Setter Property="IsEnabled" Value="True"/>
                        <Style.Triggers>
                          <DataTrigger Binding="{Binding DataContext.Inspection4, ElementName=WorkflowHost}" Value="{x:Null}">
                            <Setter Property="IsEnabled" Value="False"/>
                          </DataTrigger>
                        </Style.Triggers>
                      </Style>
                    </Button.Style>
                  </Button>
                </StackPanel>

                <workflow:WorkflowControl x:Name="WorkflowHost" Margin="0,12,0,0"/>
              </StackPanel>
            </GroupBox>

            <GroupBox Header="Backend" Margin="0,12,0,0" DataContext="{Binding DataContext, ElementName=WorkflowHost}">
              <Grid Margin="8">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                  <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto"/>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Role" VerticalAlignment="Center"/>
                <TextBox Grid.Column="1" Margin="8,0" Width="160"
                         Text="{Binding RoleId, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="1" Text="ROI" VerticalAlignment="Center"/>
                <TextBox Grid.Row="1" Grid.Column="1" Margin="8,4,8,0" Width="160"
                         Text="{Binding RoiId, UpdateSourceTrigger=PropertyChanged}"/>

                <TextBlock Grid.Row="2" Text="mm/px" VerticalAlignment="Center"/>
                <TextBox Grid.Row="2" Grid.Column="1" Margin="8,4,8,0" Width="120"
                         Text="{Binding MmPerPx, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F4}}"/>

                <TextBlock Grid.Row="3" Text="Backend" VerticalAlignment="Center"/>
                <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="8,4,8,0">
                  <TextBox Width="260" Margin="0,0,8,0"
                           Text="{Binding BackendBaseUrl, UpdateSourceTrigger=PropertyChanged}"/>
                  <Button Content="Health" Padding="12,4"
                          Command="{Binding RefreshHealthCommand}"/>
                </StackPanel>

                <TextBlock Grid.Row="3" Grid.Column="2" Margin="8,4,0,0"
                           Text="{Binding HealthSummary}" TextWrapping="Wrap" Width="200"/>
              </Grid>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </TabItem>
      <TabItem Header="Batch Inspection" DataContext="{Binding DataContext, ElementName=WorkflowHost}">
        <Grid Margin="0">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
          </Grid.RowDefinitions>
          <StackPanel Orientation="Horizontal" Margin="8">
            <TextBox Width="420"
                     IsReadOnly="True"
                     Text="{Binding BatchFolder, UpdateSourceTrigger=PropertyChanged}"/>
            <Button Content="Browse..."
                    Margin="8,0,0,0"
                    Padding="12,4"
                    Command="{Binding BrowseBatchFolderCommand}"/>
            <Button Content="Start Inspection"
                    Margin="8,0,0,0"
                    Padding="12,4"
                    Command="{Binding StartBatchCommand}"
                    IsEnabled="{Binding CanStartBatch}"/>
            <TextBlock Margin="12,0,0,0"
                       VerticalAlignment="Center"
                       Text="{Binding BatchSummary}"/>
          </StackPanel>

          <Grid Grid.Row="1" Margin="8">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*"/>
              <ColumnDefinition Width="260"/>
            </Grid.ColumnDefinitions>

            <Grid x:Name="BatchGrid" Loaded="BatchGrid_Loaded">
              <!-- Imagen base -->
              <Image x:Name="BaseImage"
                     Source="{Binding BatchImageSource}"
                     Stretch="Uniform"
                     HorizontalAlignment="Center"
                     VerticalAlignment="Center"
                     SnapsToDevicePixels="True"
                     RenderOptions.BitmapScalingMode="HighQuality"
                     Panel.ZIndex="0"/>

              <!-- Overlay exactamente encima del rectángulo visible de BaseImage -->
              <Canvas x:Name="Overlay"
                      Width="{Binding ElementName=BaseImage, Path=ActualWidth}"
                      Height="{Binding ElementName=BaseImage, Path=ActualHeight}"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      IsHitTestVisible="False"
                      Panel.ZIndex="1">
                <!-- Heatmap del ROI: se posiciona y escala desde código -->
                <Image x:Name="HeatmapImage"
                       Stretch="Fill"
                       Opacity="0.65"
                       Visibility="Collapsed"
                       SnapsToDevicePixels="True"
                       UseLayoutRounding="True"
                       RenderOptions.BitmapScalingMode="HighQuality"/>
              </Canvas>
            </Grid>

            <StackPanel Grid.Column="1" Margin="8,0,0,0">
              <TextBlock Text="Heatmap cutoff (%)"/>
              <Slider Minimum="0"
                      Maximum="100"
                      TickFrequency="5"
                      IsSnapToTickEnabled="True"
                      Value="{Binding HeatmapCutoffPercent, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
              <TextBlock Margin="0,8,0,0"
                         Text="{Binding HeatmapInfo}"/>
            </StackPanel>
          </Grid>

          <DataGrid Grid.Row="2"
                    Margin="8"
                    ItemsSource="{Binding BatchRows}"
                    AutoGenerateColumns="False"
                    HeadersVisibility="Column"
                    IsReadOnly="True"
                    CanUserAddRows="False"
                    RowHeaderWidth="0">
            <DataGrid.Columns>
              <DataGridTextColumn Header="File" Binding="{Binding FileName}" Width="*"/>
              <DataGridTemplateColumn Header="ROI 1" Width="70">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <Ellipse Width="18" Height="18">
                      <Ellipse.Style>
                        <Style TargetType="Ellipse">
                          <Setter Property="Fill" Value="Gray"/>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding ROI1}" Value="{x:Static workflow:BatchCellStatus.Ok}">
                              <Setter Property="Fill" Value="LimeGreen"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI1}" Value="{x:Static workflow:BatchCellStatus.Nok}">
                              <Setter Property="Fill" Value="Red"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI1}" Value="{x:Static workflow:BatchCellStatus.Unknown}">
                              <Setter Property="Fill" Value="Gray"/>
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Ellipse.Style>
                    </Ellipse>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
              <DataGridTemplateColumn Header="ROI 2" Width="70">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <Ellipse Width="18" Height="18">
                      <Ellipse.Style>
                        <Style TargetType="Ellipse">
                          <Setter Property="Fill" Value="Gray"/>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding ROI2}" Value="{x:Static workflow:BatchCellStatus.Ok}">
                              <Setter Property="Fill" Value="LimeGreen"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI2}" Value="{x:Static workflow:BatchCellStatus.Nok}">
                              <Setter Property="Fill" Value="Red"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI2}" Value="{x:Static workflow:BatchCellStatus.Unknown}">
                              <Setter Property="Fill" Value="Gray"/>
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Ellipse.Style>
                    </Ellipse>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
              <DataGridTemplateColumn Header="ROI 3" Width="70">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <Ellipse Width="18" Height="18">
                      <Ellipse.Style>
                        <Style TargetType="Ellipse">
                          <Setter Property="Fill" Value="Gray"/>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding ROI3}" Value="{x:Static workflow:BatchCellStatus.Ok}">
                              <Setter Property="Fill" Value="LimeGreen"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI3}" Value="{x:Static workflow:BatchCellStatus.Nok}">
                              <Setter Property="Fill" Value="Red"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI3}" Value="{x:Static workflow:BatchCellStatus.Unknown}">
                              <Setter Property="Fill" Value="Gray"/>
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Ellipse.Style>
                    </Ellipse>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
              <DataGridTemplateColumn Header="ROI 4" Width="70">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <Ellipse Width="18" Height="18">
                      <Ellipse.Style>
                        <Style TargetType="Ellipse">
                          <Setter Property="Fill" Value="Gray"/>
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding ROI4}" Value="{x:Static workflow:BatchCellStatus.Ok}">
                              <Setter Property="Fill" Value="LimeGreen"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI4}" Value="{x:Static workflow:BatchCellStatus.Nok}">
                              <Setter Property="Fill" Value="Red"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding ROI4}" Value="{x:Static workflow:BatchCellStatus.Unknown}">
                              <Setter Property="Fill" Value="Gray"/>
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Ellipse.Style>
                    </Ellipse>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
            </DataGrid.Columns>
          </DataGrid>

          <TextBlock Grid.Row="3"
                     Margin="8"
                     Text="{Binding BatchStatus}"/>
        </Grid>
      </TabItem>
    </TabControl>

      <!-- ===== Viewer/Canvas (right) ===== -->
      <Grid Grid.Column="0" Grid.RowSpan="2" x:Name="ViewerHost">
        <Grid Margin="10">
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>

          <AdornerDecorator Grid.Row="1" Margin="0,8,0,0">
            <Grid Background="#111">
              <Grid>
                <Image x:Name="ImgMain" Stretch="Uniform" Panel.ZIndex="0" />
                <Image x:Name="HeatmapOverlay"
                       IsHitTestVisible="False"
                       Stretch="Fill"
                       HorizontalAlignment="Left"
                       VerticalAlignment="Top"
                       SnapsToDevicePixels="True"
                       Opacity="{Binding HeatmapOverlayOpacity, RelativeSource={RelativeSource AncestorType=Window}}"
                       Visibility="Collapsed"
                       Panel.ZIndex="1"/>
                <Canvas x:Name="CanvasROI"
                        Background="Transparent"
                        IsHitTestVisible="True"
                        Panel.ZIndex="2"/>
                <local:RoiOverlay x:Name="RoiOverlay"
                                  Visibility="Collapsed"
                                  IsHitTestVisible="False"
                                  Panel.ZIndex="3"
                                  HorizontalAlignment="Stretch"
                                  VerticalAlignment="Stretch"/>
              </Grid>
            </Grid>
          </AdornerDecorator>

          <!-- ===== HUD: ROI list (top-left) ===== -->
          <Grid x:Name="RoiHudOverlay"
                Grid.Row="1"
                VerticalAlignment="Top"
                HorizontalAlignment="Left"
                Margin="12,8,0,0"
                Panel.ZIndex="400"
                IsHitTestVisible="True"
                Visibility="Collapsed">
            <Border x:Name="RoiHudPanel"
                    Background="#CC000000"
                    BorderBrush="#39FF14"
                    BorderThickness="1.5"
                    CornerRadius="0"
                    Padding="8">
              <StackPanel x:Name="RoiHudStack" />
            </Border>
          </Grid>

          <Border x:Name="RoiVisibilityPanel"
                  Grid.Row="2"
                  HorizontalAlignment="Left"
                  VerticalAlignment="Center"
                  Margin="8,6,8,8"
                  Padding="6"
                  Background="#CC1E1E1E"
                  CornerRadius="0"
                  Panel.ZIndex="1"
                  DataContext="{Binding DataContext, ElementName=WorkflowHost}">
            <StackPanel Orientation="Horizontal">
              <StackPanel.Resources>
                <Style TargetType="Button">
                  <Setter Property="Foreground" Value="White"/>
                </Style>
                <Style TargetType="ToggleButton">
                  <Setter Property="Foreground" Value="White"/>
                </Style>
                <Style TargetType="CheckBox">
                  <Setter Property="Foreground" Value="White"/>
                </Style>
                <Style TargetType="TextBlock">
                  <Setter Property="Foreground" Value="White"/>
                </Style>
              </StackPanel.Resources>
              <CheckBox x:Name="ChkShowMaster1Pattern"
                        IsChecked="{Binding ShowMaster1Pattern}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                  <TextBlock Text="Master 1"/>
                </StackPanel>
              </CheckBox>
              <CheckBox x:Name="ChkShowMaster1Inspection"
                        IsChecked="{Binding ShowMaster1Inspection}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                  <TextBlock Text="Search 1"/>
                </StackPanel>
              </CheckBox>
              <CheckBox x:Name="ChkShowMaster2Pattern"
                        IsChecked="{Binding ShowMaster2Pattern}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                  <TextBlock Text="Master 2"/>
                </StackPanel>
              </CheckBox>
              <CheckBox x:Name="ChkShowMaster2Inspection"
                        IsChecked="{Binding ShowMaster2Inspection}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                  <TextBlock Text="Search 2"/>
                </StackPanel>
              </CheckBox>
              <CheckBox x:Name="ChkShowInspectionRoi"
                        IsChecked="{Binding ShowInspectionRoi}"
                        Margin="0,0,6,0"
                        Checked="RoiVisibilityCheckChanged"
                        Unchecked="RoiVisibilityCheckChanged">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="&#xE8A4;" FontFamily="Segoe MDL2 Assets" Margin="0,0,4,0"/>
                  <TextBlock Text="Inspection"/>
                </StackPanel>
              </CheckBox>
            </StackPanel>
          </Border>
        </Grid>
        <Grid x:Name="DiskStatusHUD"
              HorizontalAlignment="Right"
              VerticalAlignment="Top"
              Margin="12"
              Panel.ZIndex="950"
              Visibility="Collapsed"
              IsHitTestVisible="False">
          <Border x:Name="DiskStatusPanel"
                  Background="#CC000000"
                  BorderBrush="#39FF14"
                  BorderThickness="1.5"
                  CornerRadius="0"
                  Padding="8">
            <TextBlock x:Name="DiskStatusText"
                       Text=""
                       FontFamily="Segoe UI"
                       FontWeight="Bold"
                       FontSize="22"
                       Foreground="White"/>
          </Border>
        </Grid>
        <!-- ===== HUD: bottom-right Heatmap controls ===== -->
        <Grid x:Name="HudOverlay" Panel.ZIndex="1000" IsHitTestVisible="True">
          <Border x:Name="HeatmapHUD"
                  HorizontalAlignment="Right"
                  VerticalAlignment="Bottom"
                  Margin="16"
                  Background="#CC000000"
                  CornerRadius="0"
                  Padding="8"
                  IsHitTestVisible="True">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
              <CheckBox x:Name="ChkHeatmap"
                        Content="Heatmap"
                        IsChecked="True"
                        Margin="0,0,8,0"/>
              <TextBlock x:Name="HeatmapScaleLabel"
                         Text="Heatmap Scale: 1.00"
                         Foreground="#39FF14"
                         FontFamily="Segoe UI"
                         FontWeight="SemiBold"
                         Margin="0,0,8,0"/>
              <Slider x:Name="HeatmapScaleSlider"
                      Width="160"
                      Minimum="0.10"
                      Maximum="2.00"
                      Value="1.00"
                      Margin="0,0,12,0"/>
              <TextBlock Text="Opacity"
                         Foreground="#39FF14"
                         FontFamily="Segoe UI"
                         FontWeight="SemiBold"
                         Margin="0,0,8,0"/>
              <Slider x:Name="HeatmapOpacitySlider"
                      Width="140"
                      Minimum="0"
                      Maximum="1"
                      TickFrequency="0.05"
                      IsSnapToTickEnabled="True"
                      Value="{Binding HeatmapOverlayOpacity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
            </StackPanel>
          </Border>
        </Grid>
    </Grid>
  </Grid>
</Window>
