<UserControl x:Class="BrakeDiscInspector_GUI_ROI.Workflow.WorkflowControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:m="clr-namespace:BrakeDiscInspector_GUI_ROI.Models"
             xmlns:w="clr-namespace:BrakeDiscInspector_GUI_ROI.Workflow"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="480">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </UserControl.Resources>
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10" Orientation="Vertical">
            <StackPanel.Resources>
                <Style TargetType="GroupBox">
                    <Setter Property="Margin" Value="0,0,0,12"/>
                </Style>
            </StackPanel.Resources>

            <GroupBox Header="Backend">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="Role" VerticalAlignment="Center"/>
                    <TextBox Grid.Column="1" Margin="8,0" Width="160"
                             Text="{Binding RoleId, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Text="ROI" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Margin="8,4,8,0" Width="160"
                             Text="{Binding RoiId, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="2" Text="mm/px" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="2" Grid.Column="1" Margin="8,4,8,0" Width="120"
                             Text="{Binding MmPerPx, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F4}}"/>

                    <TextBlock Grid.Row="3" Text="Backend" VerticalAlignment="Center"/>
                    <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal" Margin="8,4,8,0">
                        <TextBox Width="260" Margin="0,0,8,0"
                                 Text="{Binding BackendBaseUrl, UpdateSourceTrigger=PropertyChanged}"/>
                        <Button Content="Health" Padding="12,4"
                                Command="{Binding RefreshHealthCommand}"/>
                    </StackPanel>

                    <TextBlock Grid.Row="3" Grid.Column="2" Margin="8,4,0,0"
                               Text="{Binding HealthSummary}" TextWrapping="Wrap" Width="200"/>
                </Grid>
            </GroupBox>

            <GroupBox Header="Inspection ROIs">
                <DockPanel Margin="8">
                    <StackPanel DockPanel.Dock="Bottom" Margin="0,12,0,0">
                        <!-- Per-selected-ROI summary -->
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Score:"/>
                            <TextBlock Text="{Binding SelectedInspectionRoi.LastScore, StringFormat={}{0:0.000}}" Margin="4,0,12,0"/>
                            <TextBlock Text="Threshold:"/>
                            <TextBlock Text="{Binding SelectedInspectionRoi.CalibratedThreshold, StringFormat={}{0:0.000}}" Margin="4,0,12,0"/>
                            <TextBlock Text="Result:"/>
                            <TextBlock Margin="4,0,0,0">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="—"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding SelectedInspectionRoi.LastResultOk}" Value="True">
                                                <Setter Property="Text" Value="OK"/>
                                                <Setter Property="Foreground" Value="ForestGreen"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding SelectedInspectionRoi.LastResultOk}" Value="False">
                                                <Setter Property="Text" Value="NOK"/>
                                                <Setter Property="Foreground" Value="DarkRed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                            <Button Content="Infer Enabled"
                                    Command="{Binding InferEnabledRoisCommand}"
                                    Padding="12,4"/>
                        </StackPanel>
                    </StackPanel>
                    <TabControl ItemsSource="{Binding InspectionRois}"
                                SelectedItem="{Binding SelectedInspectionRoi}">
                        <TabControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type m:InspectionRoiConfig}">
                                <TextBlock Text="{Binding Name}"/>
                            </DataTemplate>
                        </TabControl.ItemTemplate>
                        <TabControl.ContentTemplate>
                            <DataTemplate DataType="{x:Type m:InspectionRoiConfig}">
                                <Grid Margin="0,8,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Name" Width="70" VerticalAlignment="Center"/>
                                        <TextBox Text="{Binding Name}" Width="200" Margin="0,0,12,0"/>
                                        <CheckBox Content="Enabled" IsChecked="{Binding Enabled}" VerticalAlignment="Center"/>
                                        <Button Margin="8,0,0,0"
                                                Padding="12,4"
                                                Click="BtnToggleEdit_Click"
                                                IsEnabled="{Binding Enabled}">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Content">
                                                        <Setter.Value>
                                                            <Binding Path="Index" StringFormat="Edit ROI{0}"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsEditable}" Value="True">
                                                            <Setter Property="Content">
                                                                <Setter.Value>
                                                                    <Binding Path="Index" StringFormat="Save ROI{0}"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>

                                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="ModelKey" Width="70" VerticalAlignment="Center"/>
                                        <TextBox Text="{Binding ModelKey}" Width="220" Margin="0,0,12,0"/>
                                        <CheckBox Content="Memory fit" IsChecked="{Binding TrainMemoryFit}" VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <Grid Grid.Row="2" Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Dataset" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                        <TextBox Grid.Column="1" Text="{Binding DatasetPath}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                        <Button Grid.Column="2"
                                                Content="Browse..."
                                                Padding="12,4"
                                                Command="{Binding DataContext.BrowseDatasetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        <Button Grid.Column="3" Content="Open Folder" Padding="12,4"
                                                Command="{Binding DataContext.OpenDatasetFolderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                    </Grid>

                                    <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="{Binding DatasetStatus}">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                    <Setter Property="Foreground" Value="DarkRed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DatasetReady}" Value="True">
                                                            <Setter Property="Foreground" Value="ForestGreen"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <TextBlock Text="  "/>
                                        <TextBlock Text="{Binding DatasetCountsText}"/>
                                    </StackPanel>

                                    <ProgressBar Grid.Row="4" Height="4" Margin="0,4,0,0"
                                                 IsIndeterminate="True"
                                                 Visibility="{Binding IsDatasetLoading, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                    <StackPanel Grid.Row="5" Margin="0,8,0,0">
                                        <TextBlock Text="OK dataset" FontWeight="SemiBold" Margin="0,6,0,4"/>
                                        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Disabled"
                                                      Height="110">
                                            <ItemsControl ItemsSource="{Binding OkPreview}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type w:DatasetPreviewItem}">
                                                        <Border BorderBrush="#303030" BorderThickness="1" Margin="0">
                                                            <Image Source="{Binding Thumbnail}"
                                                                   Width="120"
                                                                   Height="90"
                                                                   Margin="0,0,8,0"
                                                                   Cursor="Hand"
                                                                   Stretch="UniformToFill"
                                                                   MouseLeftButtonUp="DatasetImage_Click"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>

                                        <TextBlock Text="NG dataset" FontWeight="SemiBold" Margin="0,8,0,4"/>
                                        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Disabled"
                                                      Height="110">
                                            <ItemsControl ItemsSource="{Binding NgPreview}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <StackPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type w:DatasetPreviewItem}">
                                                        <Border BorderBrush="#303030" BorderThickness="1" Margin="0">
                                                            <Image Source="{Binding Thumbnail}"
                                                                   Width="120"
                                                                   Height="90"
                                                                   Margin="0,0,8,0"
                                                                   Cursor="Hand"
                                                                   Stretch="UniformToFill"
                                                                   MouseLeftButtonUp="DatasetImage_Click"/>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                    </StackPanel>

                                    <StackPanel Grid.Row="6" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                                        <Button Content="Load model"
                                                Padding="12,4"
                                                Margin="0,0,8,0"
                                                Tag="{Binding Index}"
                                                Click="LoadModelButton_Click"/>
                                        <Button Content="Train"
                                                Padding="12,4"
                                                Margin="0,0,8,0"
                                                Command="{Binding DataContext.TrainSelectedRoiCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        <Button Content="Calibrate"
                                                Padding="12,4"
                                                Margin="0,0,8,0"
                                                Command="{Binding DataContext.CalibrateSelectedRoiCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        <Button Content="Evaluate ROI"
                                                Padding="12,4"
                                                Command="{Binding DataContext.EvaluateSelectedRoiCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                    </StackPanel>

                                    <StackPanel Grid.Row="7" Orientation="Horizontal" Margin="0,8,0,0">
                                        <TextBlock Text="Score:"/>
                                        <TextBlock Text="{Binding LastScore, StringFormat={}{0:0.000}}" Margin="4,0,12,0"/>
                                        <TextBlock Text="Threshold:"/>
                                        <TextBlock Text="{Binding CalibratedThreshold, StringFormat={}{0:0.000}}" Margin="4,0,12,0"/>
                                        <TextBlock Text="Result:"/>
                                        <TextBlock Margin="4,0,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="—"/>
                                                    <Setter Property="Foreground" Value="Gray"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding LastResultOk}" Value="True">
                                                            <Setter Property="Text" Value="OK"/>
                                                            <Setter Property="Foreground" Value="ForestGreen"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding LastResultOk}" Value="False">
                                                            <Setter Property="Text" Value="NOK"/>
                                                            <Setter Property="Foreground" Value="DarkRed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </TabControl.ContentTemplate>
                    </TabControl>
                </DockPanel>
            </GroupBox>

            <GroupBox Header="Visualization">
                <StackPanel Margin="8">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                        <TextBlock Text="Heatmap opacity" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <Slider Minimum="0" Maximum="1" Width="200" Margin="0,0,8,0"
                                Value="{Binding HeatmapOpacity, Mode=TwoWay}"/>
                        <TextBlock Text="{Binding HeatmapOpacity, StringFormat={}{0:F2}}" VerticalAlignment="Center"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Local threshold" VerticalAlignment="Center" Margin="0,0,8,0"/>
                        <Slider Minimum="0" Maximum="5" Width="200" Margin="0,0,8,0"
                                Value="{Binding LocalThreshold, Mode=TwoWay}"/>
                        <TextBox Width="80" Text="{Binding LocalThreshold, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:F3}}"/>
                    </StackPanel>
                </StackPanel>
            </GroupBox>

            <GroupBox Header="Master ROIs">
                <StackPanel Margin="8">
                    <WrapPanel Margin="0,0,0,6">
                        <ComboBox Width="120"
                                  ItemsSource="{Binding Master1RoleOptions}"
                                  SelectedItem="{Binding SelectedMaster1Role}"
                                  Margin="0,0,6,0"/>
                        <ComboBox Width="120"
                                  ItemsSource="{Binding AvailableRoiShapes}"
                                  SelectedItem="{Binding SelectedMaster1Shape}"
                                  Margin="0,0,6,0"/>
                        <Button Content="Create"
                                MinHeight="26"
                                Command="{Binding CreateMaster1RoiCommand}"
                                Padding="8,4"/>
                        <Button Content="{Binding Master1EditButtonText}"
                                MinHeight="26"
                                Command="{Binding ToggleEditMaster1RoiCommand}"
                                Padding="8,4"
                                Margin="6,0,0,0"/>
                        <Button Content="Remove"
                                MinHeight="26"
                                Command="{Binding RemoveMaster1RoiCommand}"
                                Padding="8,4"
                                Margin="6,0,0,0"/>
                    </WrapPanel>

                    <WrapPanel>
                        <ComboBox Width="120"
                                  ItemsSource="{Binding Master2RoleOptions}"
                                  SelectedItem="{Binding SelectedMaster2Role}"
                                  Margin="0,0,6,0"/>
                        <ComboBox Width="120"
                                  ItemsSource="{Binding AvailableRoiShapes}"
                                  SelectedItem="{Binding SelectedMaster2Shape}"
                                  Margin="0,0,6,0"/>
                        <Button Content="Create"
                                MinHeight="26"
                                Command="{Binding CreateMaster2RoiCommand}"
                                Padding="8,4"/>
                        <Button Content="{Binding Master2EditButtonText}"
                                MinHeight="26"
                                Command="{Binding ToggleEditMaster2RoiCommand}"
                                Padding="8,4"
                                Margin="6,0,0,0"/>
                        <Button Content="Remove"
                                MinHeight="26"
                                Command="{Binding RemoveMaster2RoiCommand}"
                                Padding="8,4"
                                Margin="6,0,0,0"/>
                    </WrapPanel>
                </StackPanel>
            </GroupBox>

            <WrapPanel Margin="0,0,0,12">
                <Button Content="Clear Canvas"
                        Padding="12,4"
                        Click="ClearCanvasButton_Click"/>
            </WrapPanel>

            <GroupBox Header="Regions">
                <ListView ItemsSource="{Binding Regions}" Height="160">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="x" DisplayMemberBinding="{Binding x, StringFormat={}{0:F1}}" Width="60"/>
                            <GridViewColumn Header="y" DisplayMemberBinding="{Binding y, StringFormat={}{0:F1}}" Width="60"/>
                            <GridViewColumn Header="w" DisplayMemberBinding="{Binding w, StringFormat={}{0:F1}}" Width="60"/>
                            <GridViewColumn Header="h" DisplayMemberBinding="{Binding h, StringFormat={}{0:F1}}" Width="60"/>
                            <GridViewColumn Header="area px" DisplayMemberBinding="{Binding area_px, StringFormat={}{0:F1}}" Width="80"/>
                            <GridViewColumn Header="area mm²" DisplayMemberBinding="{Binding area_mm2, StringFormat={}{0:F2}}" Width="100"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </GroupBox>
        </StackPanel>
    </ScrollViewer>
</UserControl>
