# API contracts

This file documents the actual payloads the GUI sends (see `Workflow/BackendClient.cs`) and the responses generated by `backend/app.py`. Example bodies are copied from live code paths; there are no undocumented routes. The GUI always supplies `role_id`, `roi_id`, `mm_per_px` and the ROI mask (`shape`) for both manual and batch calls, and will auto-trigger `/fit_ok` before `/infer` when the backend reports an unfitted memory.

## `GET /health`
- **Request:** none (optional headers: `x-request-id`, `x-recipe-id`).
- **Response:**
```json
{
  "status": "ok",
  "device": "cuda",
  "model": "vit_small_patch14_dinov2.lvd142m",
  "version": "0.1.0",
  "request_id": "a9d1f7d7-6b94-4e1c-9b6b-acde0a0b9c0d",
  "recipe_id": "default",
  "reason": "cuda_not_available"
}
```
- `reason` is only present when CUDA is unavailable.
- Errors: standard FastAPI errors (5xx) if dependencies fail to import.

## `POST /fit_ok`
- **Content type:** `multipart/form-data`.
- **Fields:**
  - `role_id` (string, required) – e.g. `Inspection`, `Master1`.
  - `roi_id` (string, required) – e.g. `inspection-1`.
  - `mm_per_px` (float, required).
  - `images` (one or many files, required) – PNG/JPG ROI crops.
  - `memory_fit` (bool string, optional) – when `true`, disables the coreset subsampling (all embeddings are kept).
  - `recipe_id` (string, optional) – overrides the recipe context if supplied.
  - `model_key` (string, optional) – overrides the stored model key (defaults to `roi_id`).
- **Response:**
```json
{
  "n_embeddings": 512,
  "coreset_size": 128,
  "token_shape": [24, 24],
  "coreset_rate_requested": 0.1,
  "coreset_rate_applied": 0.25,
  "request_id": "a9d1f7d7-6b94-4e1c-9b6b-acde0a0b9c0d",
  "recipe_id": "default"
}
```
- **Errors:**
  - `400` if no images were included or token grids vary between images.
  - `500` with `{"error": "...", "trace": "stack", "request_id": "...", "recipe_id": "..."}` for unexpected exceptions.

## `POST /calibrate_ng`
- **Content type:** `application/json`.
- **Body:**
```json
{
  "role_id": "Inspection",
  "roi_id": "inspection-1",
  "mm_per_px": 0.2,
  "ok_scores": [0.12, 0.16, 0.2],
  "ng_scores": [0.8, 0.9],
  "area_mm2_thr": 1.0,
  "score_percentile": 99,
  "recipe_id": "default"
}
```
- **Response:**
```json
{
  "threshold": 0.47,
  "ok_mean": 0.16,
  "ng_mean": 0.85,
  "p99_ok": 0.2,
  "p5_ng": 0.81,
  "mm_per_px": 0.2,
  "area_mm2_thr": 1.0,
  "score_percentile": 99,
  "request_id": "a9d1f7d7-6b94-4e1c-9b6b-acde0a0b9c0d",
  "recipe_id": "default"
}
```
- **Errors:** `500` with `{error, trace, request_id, recipe_id}` if the payload is missing keys or NumPy raises.

## `POST /infer`
- **Content type:** `multipart/form-data`.
- **Fields:**
  - `role_id`, `roi_id`, `mm_per_px` (same as `/fit_ok`).
  - `image`: the canonical ROI PNG/JPG exported by the GUI.
  - `shape`: optional JSON string describing the ROI mask (see below).
  - `recipe_id`, `model_key` (optional): same meaning as `/fit_ok`.
- **Response:**
```json
{
  "score": 0.42,
  "threshold": 0.5,
  "token_shape": [24, 24],
  "heatmap_png_base64": "iVBORw0KGgoAAAANS...",
  "regions": [
    {
      "bbox": [120, 80, 24, 32],
      "area_px": 640.0,
      "area_mm2": 25.6
    }
  ],
  "request_id": "a9d1f7d7-6b94-4e1c-9b6b-acde0a0b9c0d",
  "recipe_id": "default"
}
```
- **Error handling:**
  - `400` when the model was not fitted yet or when the token grid does not match (message returned in `error`).
  - `500` on unexpected exceptions (see `infer` handler in `backend/app.py`); responses include `request_id` and `recipe_id`.

## `GET /manifest`
- **Query params:** `role_id`, `roi_id`.
- **Response:** `{role_id, roi_id, memory, calib, datasets}` where `datasets` is the same structure returned by `/datasets/list`.

## Dataset endpoints
- `POST /datasets/ok/upload` (`multipart/form-data`): fields `role_id`, `roi_id`, `images[]`. Returns `{status, saved[]}` (filenames).
- `POST /datasets/ng/upload` (`multipart/form-data`): fields `role_id`, `roi_id`, `images[]`. Returns `{status, saved[]}` (filenames).
- `GET /datasets/list`: query `role_id`, `roi_id`. Returns `{role_id, roi_id, classes: {ok|ng: {count, files[]}}}`.
- `DELETE /datasets/file`: query `role_id`, `roi_id`, `label`, `filename`. Returns `{deleted, filename}`.
- `DELETE /datasets/clear`: query `role_id`, `roi_id`, `label`. Returns `{cleared, label}`.

## Shape JSON schema
When present, the GUI sends the ROI mask to the backend in canonical ROI coordinates (post crop/rotation). The backend only recognises three shapes (see `backend/roi_mask.py`):
```json
{ "kind": "rect", "x": 0, "y": 0, "w": 448, "h": 448 }
{ "kind": "circle", "cx": 224, "cy": 224, "r": 210 }
{ "kind": "annulus", "cx": 224, "cy": 224, "r": 210, "r_inner": 150 }
```
Unknown kinds fall back to a full mask.

## File-based contracts
### Dataset samples (GUI side)
`DatasetManager.SaveSampleAsync` stores each ROI crop as `PNG` plus a JSON file under `Recipes/<LayoutName>/Dataset/datasets/<roi_id>/<ok|ng>/` with the following schema:
```json
{
  "role_id": "Inspection",
  "roi_id": "inspection-1",
  "mm_per_px": 0.2,
  "shape_json": "{\"kind\":\"rect\",\"x\":0,\"y\":0,\"w\":448,\"h\":448}",
  "source_path": "C:/images/brake_disc_001.png",
  "angle": 0.0,
  "timestamp": "2025-02-12T10:33:45.1234567Z"
}
```
No GUI-side manifest file is produced; dataset readiness is computed on the fly by `AnalyzeFolderDataset`/`AnalyzeCsvDataset`. Backend status can be queried via `GET /manifest`, which aggregates memory, calibration and dataset counts from `ModelStore`.

### Layouts
ROI definitions (masters + inspection slots) live in `Layouts/*.layout.json`. Each inspection slot in `MasterLayout.InspectionRois` must keep its `Id` as `Inspection_<n>` for compatibility with dataset folders and backend `roi_id` conventions.
